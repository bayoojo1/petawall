async function runVulnerabilityScan() {
    const url = document.getElementById('target-url').value;
    const scanType = document.getElementById('scan-type').value;
    
    if (!url) return alert('Please enter a target URL');
    
    // Show loading
    document.getElementById('vuln-loading').style.display = 'block';
    document.getElementById('vuln-results').style.display = 'none';
    document.getElementById('vuln-btn').disabled = true;
    document.getElementById('current-task').innerHTML = `${scanType.charAt(0).toUpperCase() + scanType.slice(1)} scan in progress...`;
    
    try {
        const formData = new FormData();
        formData.append('target', url);
        formData.append('scan_type', scanType);
        formData.append('tool', 'vulnerability');
        
        const response = await fetch('api.php', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        console.log('API Response:', data); // Debug log
        
        document.getElementById('vuln-loading').style.display = 'none';
        
        
        if (data.error) {
            alert('Error: ' + data.error);
            return;
        }
        
        if (!data.success) {
            alert('Scan failed: ' + (data.message || 'Unknown error'));
            return;
        }
        
        document.getElementById('vuln-results').style.display = 'block';
        document.getElementById('vuln-btn').disabled = false;
        displayVulnerabilityResults(data);
        
    } catch (error) {
        document.getElementById('vuln-loading').style.display = 'none';
        console.error('Request failed:', error);
        alert('Request failed: ' + error.message);
    }
}

function displayVulnerabilityResults(results) {
    console.log('Raw results:', results);
    
    // Safely extract the actual data with proper error handling
    let data;
    
    if (results && results.data && results.data.data && results.data.data.vulnerabilities) {
        data = results.data.data;
    } else if (results && results.data && results.data.vulnerabilities) {
        data = results.data;
    } else if (results && results.vulnerabilities) {
        data = results;
    } else {
        console.error('Unexpected data structure:', results);
        alert('Error: Unexpected response format from server');
        return;
    }

    console.log('Processed data:', data);

    // Create the main results container
    const resultsContainer = document.getElementById('vuln-results');
    resultsContainer.innerHTML = '';

    // Create header
    const header = document.createElement('header');
    header.className = 'header-vuln fade-in';

    const scanType = data.scan_type || 'quick';
    const scanTitles = {
        'quick': 'Quick Security Scan Results',
        'full': 'Full Comprehensive Security Scan Results',
        'cms': 'CMS-Specific Security Scan Results', 
        'api': 'API Endpoints Security Scan Results'
    };

    header.innerHTML = `
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-shield-alt"></i>
                <span>${scanTitles[scanType] || 'Security Scan Results'}</span>
            </div>
            <div class="scan-info">
                <div class="scan-info-item">
                    <i class="fas fa-globe"></i>
                    <span>Target: ${data.website_info?.url || 'Unknown'}</span>
                </div>
                <div class="scan-info-item">
                    <i class="fas fa-calendar"></i>
                    <span>Scan Date: ${new Date().toLocaleDateString('en-GB')}</span>
                </div>
                <div class="scan-info-item">
                    <i class="fas fa-clock"></i>
                    <span>Duration: ${data.scan_metrics?.scan_duration || 'Unknown'}</span>
                </div>
            </div>
        </div>
    `;
    resultsContainer.appendChild(header);
    
    // Create main container
    const container = document.createElement('div');
    container.className = 'container slide-up';
    resultsContainer.appendChild(container);

    // Add Scan Metrics - FIXED CALCULATIONS
    if (data.scan_metrics) {
        const metricsSection = document.createElement('div');
        metricsSection.className = 'result-card';
        metricsSection.innerHTML = '<h3><i class="fas fa-chart-bar"></i> Scan Metrics</h3>';
        
        const metricsGrid = document.createElement('div');
        metricsGrid.className = 'metrics-grid';
        
        // Calculate actual test counts
        const totalTests = data.scan_metrics.total_tests || 0;
        const testsPassed = data.scan_metrics.tests_passed || 0;
        const testsFailed = data.scan_metrics.tests_failed || 0;
        const testsInfo = totalTests - (testsPassed + testsFailed); // Info/neutral tests
        
        metricsGrid.innerHTML = `
            <div class="metric-card">
                <div class="metric-value">${totalTests}</div>
                <div class="metric-label">Total Tests</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" style="color: #28a745;">${testsPassed}</div>
                <div class="metric-label">Tests Passed</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" style="color: #dc3545;">${testsFailed}</div>
                <div class="metric-label">Tests Failed</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" style="color: #17a2b8;">${testsInfo}</div>
                <div class="metric-label">Info Tests</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" style="color: #6c757d;">${data.scan_metrics.success_rate || 0}%</div>
                <div class="metric-label">Success Rate</div>
            </div>
        `;
        metricsSection.appendChild(metricsGrid);
        container.appendChild(metricsSection);
    }

    createScanIntelligenceSection(data, vulnerabilities, container);

    // Add summary cards - FIXED VULNERABILITY COUNT LOGIC
    const summaryCardsDiv = document.createElement('div');
    summaryCardsDiv.className = 'summary-cards-div';

    // Get vulnerabilities from the correct location
    const vulnerabilities = (data.vulnerabilities || []);
    const criticalCount = vulnerabilities.filter(v => v.severity?.toLowerCase() === 'critical').length;
    const highCount = vulnerabilities.filter(v => v.severity?.toLowerCase() === 'high').length;
    const mediumCount = vulnerabilities.filter(v => v.severity?.toLowerCase() === 'medium').length;
    const lowCount = vulnerabilities.filter(v => v.severity?.toLowerCase() === 'low').length;

    // Also check summary data if available
    const finalCritical = criticalCount;
    const finalHigh = highCount;
    const finalMedium = mediumCount;
    const finalLow = lowCount;

    summaryCardsDiv.innerHTML = `
        <div class="summary-card critical">
            <i class="fas fa-skull-crossbones fa-2x"></i>
            <div class="summary-count">${finalCritical}</div>
            <div class="summary-label">Critical</div>
        </div>
        <div class="summary-card high">
            <i class="fas fa-exclamation-triangle fa-2x"></i>
            <div class="summary-count">${finalHigh}</div>
            <div class="summary-label">High</div>
        </div>
        <div class="summary-card medium">
            <i class="fas fa-exclamation-circle fa-2x"></i>
            <div class="summary-count">${finalMedium}</div>
            <div class="summary-label">Medium</div>
        </div>
        <div class="summary-card low">
            <i class="fas fa-info-circle fa-2x"></i>
            <div class="summary-count">${finalLow}</div>
            <div class="summary-label">Low</div>
        </div>
    `;
    container.appendChild(summaryCardsDiv);
    
    // Add chart container - ONLY SHOW IF THERE ARE VULNERABILITIES
    if (finalCritical + finalHigh + finalMedium + finalLow > 0) {
        const chartContainer = document.createElement('div');
        chartContainer.className = 'chart-container fade-in';
        chartContainer.innerHTML = `
            <h3 class="chart-title"><i class="fas fa-chart-pie"></i> Vulnerability Distribution</h3>
            <div class="chart-wrapper">
                <canvas id="vuln-chart"></canvas>
            </div>
        `;
        container.appendChild(chartContainer);
        
        // Create chart
        setTimeout(() => {
            createVulnerabilityChart(finalCritical, finalHigh, finalMedium, finalLow);
        }, 100);
    }
    
    // Display Detailed Test Results - FIXED LOGIC
    if (data.detailed_test_results && data.detailed_test_results.length > 0) {
        const testResultsCard = document.createElement('div');
        testResultsCard.className = 'result-card slide-up';
        testResultsCard.innerHTML = '<h3><i class="fas fa-tasks"></i> Detailed Test Results</h3>';
        
        // Add test summary
        const testSummary = document.createElement('div');
        testSummary.className = 'test-summary';
        testSummary.innerHTML = `
            <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                <div><strong>Total Tests:</strong> ${data.detailed_test_results.length}</div>
                <div style="color: #28a745;"><strong>Passed:</strong> ${data.detailed_test_results.filter(t => t.status === 'success').length}</div>
                <div style="color: #dc3545;"><strong>Failed:</strong> ${data.detailed_test_results.filter(t => ['critical', 'high', 'medium', 'error'].includes(t.status)).length}</div>
                <div style="color: #17a2b8;"><strong>Info:</strong> ${data.detailed_test_results.filter(t => t.status === 'info').length}</div>
                <div style="color: #ffc107;"><strong>Warnings:</strong> ${data.detailed_test_results.filter(t => t.status === 'warning').length}</div>
            </div>
        `;
        testResultsCard.appendChild(testSummary);
        
        const testResultsSection = document.createElement('div');
        testResultsSection.className = 'test-results-section';
        
        // Sort tests by severity for better organization
        const severityOrder = {
            'critical': 1,
            'high': 2, 
            'medium': 3,
            'error': 4,
            'warning': 5,
            'info': 6,
            'success': 7
        };
        
        const sortedTests = [...data.detailed_test_results].sort((a, b) => {
            return (severityOrder[a.status] || 8) - (severityOrder[b.status] || 8);
        });
        
        sortedTests.forEach(test => {
            const testEl = document.createElement('div');
            testEl.className = 'test-item';
            testEl.innerHTML = `
                <div class="test-status ${test.status}"></div>
                <div class="test-content">
                    <div class="test-name">${test.name}</div>
                    <div class="test-details">${test.details || 'Test completed'}</div>
                </div>
                <div class="test-timestamp">${test.timestamp}</div>
            `;
            testResultsSection.appendChild(testEl);
        });
        
        testResultsCard.appendChild(testResultsSection);
        container.appendChild(testResultsCard);
    }

    // Create vulnerabilities result card - FIXED LOGIC
    const hasVulnerabilities = vulnerabilities.length > 0 || (finalCritical + finalHigh + finalMedium + finalLow) > 0;
    
    if (hasVulnerabilities) {
        const vulnCard = document.createElement('div');
        vulnCard.className = 'result-card slide-up';
        vulnCard.innerHTML = '<h3><i class="fas fa-bug"></i> Security Vulnerabilities</h3>';
        container.appendChild(vulnCard);
        
        const vulnList = document.createElement('div');
        vulnList.id = 'vulnerabilities-list';
        vulnCard.appendChild(vulnList);
        
        // Display vulnerabilities
        if (vulnerabilities.length > 0) {
            vulnerabilities.forEach(vuln => {
                const vulnEl = document.createElement('div');
                vulnEl.className = `vuln-item ${vuln.severity ? vuln.severity.toLowerCase() : 'unknown'} fade-in`;
                vulnEl.innerHTML = `
                    <div class="vuln-header">
                        <span class="risk-badge risk-${vuln.severity ? vuln.severity.toLowerCase() : 'unknown'}">
                            ${vuln.severity ? vuln.severity.toUpperCase() : 'UNKNOWN'}
                        </span>
                        <span class="cvss-score">CVSS: ${vuln.cvss_score || 'N/A'}</span>
                    </div>
                    <h4>${vuln.type || 'Unknown Type'}</h4>
                    <p class="vuln-description">${vuln.description || 'No description available'}</p>
                    <div class="vuln-details">
                        <div><strong>Location:</strong> ${vuln.location || 'Not specified'}</div>
                        <div><strong>Impact:</strong> ${vuln.impact || 'Not specified'}</div>
                        ${vuln.evidence ? `<div><strong>Evidence:</strong> ${vuln.evidence}</div>` : ''}
                    </div>
                    <div class="remediation">
                        <strong>Remediation:</strong> ${vuln.remediation || 'No remediation provided'}
                    </div>
                `;
                vulnList.appendChild(vulnEl);
            });
        } else {
            // If no vulnerabilities array but we have counts from summary
            vulnList.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: var(--text-light);">
                    <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                    <p>Vulnerabilities detected but detailed information not available. Check the detailed test results above.</p>
                </div>
            `;
        }
    } else {
        // Only show "No Vulnerabilities" if truly none were found
        const noVulnCard = document.createElement('div');
        noVulnCard.className = 'result-card slide-up';
        noVulnCard.innerHTML = `
            <div style="text-align: center; padding: 3rem;">
                <i class="fas fa-check-circle" style="font-size: 4rem; color: #28a745; margin-bottom: 1rem;"></i>
                <h3 style="color: #28a745;">No Security Vulnerabilities Found</h3>
                <p style="color: var(--text-light);">
                    The security scan completed successfully. 
                    ${data.scan_metrics?.tests_failed ? `${data.scan_metrics.tests_failed} security issues were found but they are classified as informational or low risk.` : 'No security issues were detected.'}
                </p>
                ${data.scan_metrics?.tests_failed ? `
                    <div style="margin-top: 1rem; padding: 1rem; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <strong>Note:</strong> While no critical vulnerabilities were found, some security improvements are recommended. 
                        Check the "Detailed Test Results" section for specific recommendations.
                    </div>
                ` : ''}
            </div>
        `;
        container.appendChild(noVulnCard);
    }
    
    // Display full scan details if available
    if (scanType === 'full' && data.full_scan_details) {
        displayFullScanDetails(data.full_scan_details, container);
    }

    // Display recommendations if available
    if (data.recommendations && data.recommendations.length > 0) {
        const recommendationsCard = document.createElement('div');
        recommendationsCard.className = 'result-card slide-up';
        recommendationsCard.innerHTML = '<h3><i class="fas fa-lightbulb"></i> Security Recommendations</h3>';
        container.appendChild(recommendationsCard);
        
        const recommendationsSection = document.createElement('div');
        recommendationsSection.className = 'scan-detail-section';
        recommendationsCard.appendChild(recommendationsSection);
        
        const recommendationsList = document.createElement('ul');
        recommendationsList.className = 'recommendations-list';
        
        data.recommendations.forEach(rec => {
            const recEl = document.createElement('li');
            recEl.className = 'fade-in';
            recEl.innerHTML = `<i class="fas fa-chevron-right"></i> ${rec}`;
            recommendationsList.appendChild(recEl);
        });
        recommendationsSection.appendChild(recommendationsList);
    }

    // Add scan metadata
    const metaSection = document.createElement('div');
    metaSection.className = 'scan-meta-section';
    metaSection.innerHTML = `
        <div class="scan-meta" style="text-align: center; padding: 1rem; color: var(--text-light); font-size: 0.9rem;">
            <span><i class="fas fa-info-circle"></i> Scan completed at ${new Date().toLocaleString()}</span>
        </div>
    `;
    container.appendChild(metaSection);
}

function createVulnerabilityChart(critical, high, medium, low) {
    const ctx = document.getElementById('vuln-chart').getContext('2d');
    
    // Destroy existing chart if it exists
    if (window.vulnChart instanceof Chart) {
        window.vulnChart.destroy();
    }

    window.vulnChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Critical', 'High', 'Medium', 'Low'],
            datasets: [{
                data: [critical, high, medium, low],
                backgroundColor: ['#dc2626', '#ea580c', '#d97706', '#65a30d'],
                borderColor: ['#fff', '#fff', '#fff', '#fff'],
                borderWidth: 2,
                hoverOffset: 15
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: {
                    top: 20,
                    bottom: 20
                }
            },
            plugins: {
                legend: { 
                    position: 'bottom',
                    labels: {
                        color: '#212529',
                        font: {
                            size: 12,
                            weight: 'bold'
                        },
                        padding: 20
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            },
            animation: {
                animateScale: true,
                animateRotate: true
            }
        }
    });
}

// Function to display additional full scan details
function displayFullScanDetails(details, container) {
    const fullScanCard = document.createElement('div');
    fullScanCard.className = 'result-card slide-up';
    fullScanCard.innerHTML = '<h3><i class="fas fa-search-plus"></i> Full Scan Details</h3>';
    container.appendChild(fullScanCard);

    let fullScanContent = '';

    if (details.comprehensive_analysis) {
        fullScanContent += `
            <div class="scan-detail-section">
                <h4><i class="fas fa-check-circle"></i> Comprehensive Analysis</h4>
                <p>This scan performed ${details.tests_performed || '100+'} security checks with ${details.scan_intensity || 'High'} intensity.</p>
                <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e6f3ff 100%); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                    <strong>Scan Coverage:</strong> ${details.scan_coverage || 'Comprehensive security assessment'}
                </div>
            </div>
        `;
    }

    // Add technology stack analysis if available
    if (details.technology_stack) {
        fullScanContent += `
            <div class="scan-detail-section">
                <h4><i class="fas fa-layer-group"></i> Technology Stack Analysis</h4>
                <div class="tech-items">
                    ${Object.entries(details.technology_stack).map(([category, items]) => `
                        ${Array.isArray(items) && items.length > 0 ? `
                            <div style="margin-bottom: 1rem;">
                                <strong>${category.replace(/_/g, ' ').toUpperCase()}:</strong>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                                    ${items.map(item => `<span class="tech-item">${item}</span>`).join('')}
                                </div>
                            </div>
                        ` : ''}
                    `).join('')}
                </div>
            </div>
        `;
    }

    // Add port scanning results if available
    if (details.open_ports && details.open_ports.length > 0) {
        fullScanContent += `
            <div class="scan-detail-section">
                <h4><i class="fas fa-network-wired"></i> Port Scanning Results</h4>
                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                    ${details.open_ports.map(port => `
                        <span style="background: ${port.status === 'open' ? '#dc2626' : '#65a30d'}; color: white; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.8rem;">
                            Port ${port.port} (${port.service || 'Unknown'})
                        </span>
                    `).join('')}
                </div>
            </div>
        `;
    }

    fullScanCard.innerHTML += fullScanContent;
}

// Function to display technology stack analysis
function displayTechnologyStackAnalysis(techStack, vulnList) {
    const techEl = document.createElement('div');
    techEl.className = 'scan-detail-section technology-stack';
    
    let techContent = '<h4><i class="fas fa-layer-group"></i> Technology Stack Analysis</h4>';
    
    // Web Server
    if (techStack.web_server && techStack.web_server.length > 0) {
        techContent += `
            <div class="tech-category">
                <h5><i class="fas fa-server"></i> Web Server</h5>
                <div class="tech-items">
                    ${techStack.web_server.map(server => `<span class="tech-item">${server}</span>`).join('')}
                </div>
            </div>
        `;
    }
    
    // Programming Languages
    if (techStack.programming_languages && techStack.programming_languages.length > 0) {
        techContent += `
            <div class="tech-category">
                <h5><i class="fas fa-code"></i> Programming Languages</h5>
                <div class="tech-items">
                    ${techStack.programming_languages.map(lang => `<span class="tech-item">${lang}</span>`).join('')}
                </div>
            </div>
        `;
    }
    
    // Frameworks
    if (techStack.frameworks && techStack.frameworks.length > 0) {
        techContent += `
            <div class="tech-category">
                <h5><i class="fas fa-cubes"></i> Frameworks</h5>
                <div class="tech-items">
                    ${techStack.frameworks.map(framework => `<span class="tech-item">${framework}</span>`).join('')}
                </div>
            </div>
        `;
    }
    
    // Database Technologies
    if (techStack.database_technologies && techStack.database_technologies.length > 0) {
        techContent += `
            <div class="tech-category">
                <h5><i class="fas fa-database"></i> Database Technologies</h5>
                <div class="tech-items">
                    ${techStack.database_technologies.map(db => `<span class="tech-item">${db}</span>`).join('')}
                </div>
            </div>
        `;
    }
    
    // Caching Technologies
    if (techStack.caching_technologies && techStack.caching_technologies.length > 0) {
        techContent += `
            <div class="tech-category">
                <h5><i class="fas fa-bolt"></i> Caching Technologies</h5>
                <div class="tech-items">
                    ${techStack.caching_technologies.map(cache => `<span class="tech-item">${cache}</span>`).join('')}
                </div>
            </div>
        `;
    }
    
    // CDN Providers
    if (techStack.cdn_providers && techStack.cdn_providers.length > 0) {
        techContent += `
            <div class="tech-category">
                <h5><i class="fas fa-cloud"></i> CDN Providers</h5>
                <div class="tech-items">
                    ${techStack.cdn_providers.map(cdn => `<span class="tech-item">${cdn}</span>`).join('')}
                </div>
            </div>
        `;
    }
    
    // Version Information
    if (techStack.version_information && Object.keys(techStack.version_information).length > 0) {
        techContent += `
            <div class="tech-category">
                <h5><i class="fas fa-info-circle"></i> Version Information</h5>
                <div class="version-items">
                    ${Object.entries(techStack.version_information).map(([tech, version]) => 
                        `<div class="version-item"><strong>${tech}:</strong> ${Array.isArray(version) ? version.join(', ') : version}</div>`
                    ).join('')}
                </div>
            </div>
        `;
    }
    
    // Security Implications
    if (techStack.security_implications && techStack.security_implications.length > 0) {
        techContent += `
            <div class="tech-category security-implications">
                <h5><i class="fas fa-shield-alt"></i> Security Implications</h5>
                <div class="implication-items">
                    ${techStack.security_implications.map(implication => 
                        `<div class="implication-item"><i class="fas fa-exclamation-triangle"></i> ${implication}</div>`
                    ).join('')}
                </div>
            </div>
        `;
    }
    
    techEl.innerHTML = techContent;
    vulnList.appendChild(techEl);
}

// Add this function to create the intelligence section
function createScanIntelligenceSection(data, vulnerabilities, container) {
    const intelligenceCard = document.createElement('div');
    intelligenceCard.className = 'result-card intelligence-section slide-up';
    
    // Calculate metrics
    const totalTests = data.scan_metrics?.total_tests || 0;
    const testsPassed = data.scan_metrics?.tests_passed || 0;
    const testsFailed = data.scan_metrics?.tests_failed || 0;
    const infoTests = totalTests - (testsPassed + testsFailed);
    const successRate = data.scan_metrics?.success_rate || 0;
    
    // Count vulnerabilities by severity
    const criticalCount = vulnerabilities.filter(v => v.severity?.toLowerCase() === 'critical').length;
    const highCount = vulnerabilities.filter(v => v.severity?.toLowerCase() === 'high').length;
    const mediumCount = vulnerabilities.filter(v => v.severity?.toLowerCase() === 'medium').length;
    const lowCount = vulnerabilities.filter(v => v.severity?.toLowerCase() === 'low').length;
    
    const totalVulnerabilities = criticalCount + highCount + mediumCount + lowCount;
    
    intelligenceCard.innerHTML = `
        <h3><i class="fas fa-brain"></i> Scan Intelligence & Analysis</h3>
        
        <div class="intelligence-grid">
            <!-- Executive Summary -->
            <div class="intelligence-card executive-summary">
                <h4><i class="fas fa-chart-line"></i> Executive Summary</h4>
                <div class="summary-content">
                    ${criticalCount > 0 ? `
                        <div class="alert critical-alert">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Critical Risk:</strong> ${criticalCount} immediate threats found that require emergency attention
                        </div>
                    ` : `
                        <div class="alert success-alert">
                            <i class="fas fa-check-circle"></i>
                            <strong>No Critical Vulnerabilities:</strong> No immediate system-compromising issues detected
                        </div>
                    `}
                    
                    ${highCount > 0 ? `
                        <div class="alert high-alert">
                            <i class="fas fa-exclamation-circle"></i>
                            <strong>High Priority:</strong> ${highCount} serious vulnerabilities need urgent remediation
                        </div>
                    ` : ''}
                    
                    <div class="summary-stats">
                        <div class="stat-item">
                            <span class="stat-value">${totalVulnerabilities}</span>
                            <span class="stat-label">Total Security Issues</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">${testsPassed}</span>
                            <span class="stat-label">Security Controls Working</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Test Analysis -->
            <div class="intelligence-card test-analysis">
                <h4><i class="fas fa-flask"></i> Test Execution Analysis</h4>
                <div class="analysis-content">
                    <div class="metric-breakdown">
                        <div class="metric">
                            <span class="metric-label">Total Security Checks:</span>
                            <span class="metric-value">${totalTests}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Security Tests Passed:</span>
                            <span class="metric-value" style="color: #28a745;">${testsPassed}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Security Issues Found:</span>
                            <span class="metric-value" style="color: #dc3545;">${testsFailed}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Information Gathered:</span>
                            <span class="metric-value" style="color: #17a2b8;">${infoTests}</span>
                        </div>
                    </div>
                    
                    <div class="success-context">
                        <i class="fas fa-info-circle"></i>
                        <strong>Success Rate Context:</strong> ${successRate.toFixed(1)}% is normal for security scans as they're designed to find problems.
                    </div>
                </div>
            </div>
            
            <!-- Vulnerability Breakdown -->
            <div class="intelligence-card vulnerability-breakdown">
                <h4><i class="fas fa-shield-alt"></i> Vulnerability Severity Analysis</h4>
                <div class="severity-content">
                    ${criticalCount > 0 ? `
                        <div class="severity-item critical">
                            <div class="severity-header">
                                <i class="fas fa-skull-crossbones"></i>
                                <span class="severity-title">Critical (${criticalCount})</span>
                                <span class="severity-badge">EMERGENCY</span>
                            </div>
                            <div class="severity-desc">
                                Immediate system-compromising vulnerabilities. Drop everything and fix these first.
                                <div class="examples">
                                    <strong>Examples:</strong> Remote code execution, authentication bypass, complete data compromise
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${highCount > 0 ? `
                        <div class="severity-item high">
                            <div class="severity-header">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span class="severity-title">High (${highCount})</span>
                                <span class="severity-badge">URGENT</span>
                            </div>
                            <div class="severity-desc">
                                Serious vulnerabilities that could lead to significant data loss or system access.
                                <div class="examples">
                                    <strong>Examples:</strong> SQL injection, sensitive data exposure, privilege escalation
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${mediumCount > 0 ? `
                        <div class="severity-item medium">
                            <div class="severity-header">
                                <i class="fas fa-exclamation-circle"></i>
                                <span class="severity-title">Medium (${mediumCount})</span>
                                <span class="severity-badge">IMPORTANT</span>
                            </div>
                            <div class="severity-desc">
                                Important security issues that should be addressed in the next development cycle.
                                <div class="examples">
                                    <strong>Examples:</strong> Cross-site scripting, CSRF, security misconfigurations
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${lowCount > 0 ? `
                        <div class="severity-item low">
                            <div class="severity-header">
                                <i class="fas fa-info-circle"></i>
                                <span class="severity-title">Low (${lowCount})</span>
                                <span class="severity-badge">ENHANCEMENT</span>
                            </div>
                            <div class="severity-desc">
                                Minor security improvements that can be handled during routine maintenance.
                                <div class="examples">
                                    <strong>Examples:</strong> Missing security headers, information disclosure, version exposure
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
            
            <!-- Action Plan -->
            <div class="intelligence-card action-plan">
                <h4><i class="fas fa-rocket"></i> Recommended Action Plan</h4>
                <div class="action-content">
                    <div class="timeline">
                        ${criticalCount > 0 ? `
                            <div class="timeline-item immediate">
                                <div class="timeline-marker" style="background: #dc2626;"></div>
                                <div class="timeline-content">
                                    <h5>IMMEDIATE (0-24 hours)</h5>
                                    <p>Fix <strong>${criticalCount} critical</strong> vulnerabilities - these pose existential threats</p>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${highCount > 0 ? `
                            <div class="timeline-item urgent">
                                <div class="timeline-marker" style="background: #ea580c;"></div>
                                <div class="timeline-content">
                                    <h5>URGENT (1-7 days)</h5>
                                    <p>Address <strong>${highCount} high-severity</strong> vulnerabilities</p>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${mediumCount > 0 ? `
                            <div class="timeline-item important">
                                <div class="timeline-marker" style="background: #d97706;"></div>
                                <div class="timeline-content">
                                    <h5>IMPORTANT (2-4 weeks)</h5>
                                    <p>Resolve <strong>${mediumCount} medium-severity</strong> issues in next sprint</p>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${lowCount > 0 ? `
                            <div class="timeline-item enhancement">
                                <div class="timeline-marker" style="background: #65a30d;"></div>
                                <div class="timeline-content">
                                    <h5>ENHANCEMENT (Next quarter)</h5>
                                    <p>Implement <strong>${lowCount} low-severity</strong> improvements</p>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${totalVulnerabilities === 0 ? `
                            <div class="timeline-item all-clear">
                                <div class="timeline-marker" style="background: #28a745;"></div>
                                <div class="timeline-content">
                                    <h5>EXCELLENT SECURITY POSTURE</h5>
                                    <p>No vulnerabilities found! Maintain current security practices and schedule regular scans.</p>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Key Insights -->
        <div class="key-insights">
            <h4><i class="fas fa-lightbulb"></i> Key Insights</h4>
            <div class="insights-grid">
                <div class="insight-item">
                    <i class="fas fa-search"></i>
                    <div class="insight-content">
                        <strong>Scan Depth:</strong> ${totalTests} comprehensive security checks performed
                    </div>
                </div>
                <div class="insight-item">
                    <i class="fas fa-clock"></i>
                    <div class="insight-content">
                        <strong>Response Time:</strong> ${criticalCount > 0 ? 'EMERGENCY response needed' : highCount > 0 ? 'Urgent attention required' : 'Standard security maintenance'}
                    </div>
                </div>
                <div class="insight-item">
                    <i class="fas fa-chart-pie"></i>
                    <div class="insight-content">
                        <strong>Risk Distribution:</strong> ${criticalCount > 0 ? 'Critical risk present' : highCount > 0 ? 'High risk focus' : 'Moderate to low risk profile'}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.appendChild(intelligenceCard);
}

// Function to display directory enumeration results
function displayDirectoryEnumerationResults(enumeration, vulnList) {
    const enumEl = document.createElement('div');
    enumEl.className = 'scan-detail-section directory-enumeration';
    
    let enumContent = '<h4><i class="fas fa-folder-tree"></i> Directory & File Enumeration</h4>';
    
    // Common Directories
    if (enumeration.common_directories && enumeration.common_directories.length > 0) {
        enumContent += `
            <div class="enum-category">
                <h5><i class="fas fa-folder"></i> Common Directories Found</h5>
                <div class="enum-items">
                    ${enumeration.common_directories.map(dir => `
                        <div class="enum-item ${dir.risk || 'low'}">
                            <span class="enum-path">${dir.path}</span>
                            <span class="enum-status">${dir.status}</span>
                            ${dir.risk ? `<span class="risk-indicator risk-${dir.risk}">${dir.risk.toUpperCase()}</span>` : ''}
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    // Hidden Files
    if (enumeration.hidden_files && enumeration.hidden_files.length > 0) {
        enumContent += `
            <div class="enum-category">
                <h5><i class="fas fa-eye-slash"></i> Hidden Files Found</h5>
                <div class="enum-items">
                    ${enumeration.hidden_files.map(file => `
                        <div class="enum-item ${file.risk || 'medium'}">
                            <span class="enum-path">${file.path}</span>
                            <span class="enum-status">${file.status}</span>
                            ${file.risk ? `<span class="risk-indicator risk-${file.risk}">${file.risk.toUpperCase()}</span>` : ''}
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    // Backup Files
    if (enumeration.backup_files && enumeration.backup_files.length > 0) {
        enumContent += `
            <div class="enum-category">
                <h5><i class="fas fa-archive"></i> Backup Files Found</h5>
                <div class="enum-items">
                    ${enumeration.backup_files.map(backup => `
                        <div class="enum-item ${backup.risk || 'high'}">
                            <span class="enum-path">${backup.path}</span>
                            <span class="enum-status">${backup.status}</span>
                            <span class="risk-indicator risk-${backup.risk || 'high'}">${(backup.risk || 'high').toUpperCase()}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    // Config Files
    if (enumeration.config_files && enumeration.config_files.length > 0) {
        enumContent += `
            <div class="enum-category">
                <h5><i class="fas fa-cog"></i> Configuration Files Found</h5>
                <div class="enum-items">
                    ${enumeration.config_files.map(config => `
                        <div class="enum-item ${config.risk || 'critical'}">
                            <span class="enum-path">${config.path}</span>
                            <span class="enum-status">${config.status}</span>
                            <span class="risk-indicator risk-${config.risk || 'critical'}">CRITICAL</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    // Log Files
    if (enumeration.log_files && enumeration.log_files.length > 0) {
        enumContent += `
            <div class="enum-category">
                <h5><i class="fas fa-clipboard-list"></i> Log Files Found</h5>
                <div class="enum-items">
                    ${enumeration.log_files.map(log => `
                        <div class="enum-item ${log.risk || 'high'}">
                            <span class="enum-path">${log.path}</span>
                            <span class="enum-status">${log.status}</span>
                            <span class="risk-indicator risk-${log.risk || 'high'}">HIGH</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    // Admin Interfaces
    if (enumeration.admin_interfaces && enumeration.admin_interfaces.length > 0) {
        enumContent += `
            <div class="enum-category">
                <h5><i class="fas fa-user-shield"></i> Admin Interfaces Found</h5>
                <div class="enum-items">
                    ${enumeration.admin_interfaces.map(admin => `
                        <div class="enum-item ${admin.risk || 'medium'}">
                            <span class="enum-path">${admin.path}</span>
                            <span class="enum-status">${admin.status}</span>
                            <span class="risk-indicator risk-${admin.risk || 'medium'}">MEDIUM</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    // Summary statistics
    const totalFound = [
        ...(enumeration.common_directories || []),
        ...(enumeration.hidden_files || []),
        ...(enumeration.backup_files || []),
        ...(enumeration.config_files || []),
        ...(enumeration.log_files || []),
        ...(enumeration.admin_interfaces || [])
    ].length;
    
    if (totalFound > 0) {
        enumContent += `
            <div class="enum-summary">
                <strong>Total items found:</strong> ${totalFound}
            </div>
        `;
    } else {
        enumContent += `
            <div class="no-enumeration">
                <i class="fas fa-check-circle"></i> No sensitive directories or files found
            </div>
        `;
    }
    
    enumEl.innerHTML = enumContent;
    vulnList.appendChild(enumEl);
}