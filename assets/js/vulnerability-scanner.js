async function runVulnerabilityScan() {
    const url = document.getElementById('target-url').value;
    const scanType = document.getElementById('scan-type').value;
    
    if (!url) return alert('Please enter a target URL');
    
    // Show loading
    document.getElementById('vuln-loading').style.display = 'block';
    document.getElementById('vuln-results').style.display = 'none';
    document.getElementById('vuln-btn').disabled = true;
    document.getElementById('current-task').innerHTML = `${scanType.charAt(0).toUpperCase() + scanType.slice(1)} scan in progress...`;
    
    try {
        const formData = new FormData();
        formData.append('target', url);
        formData.append('scan_type', scanType);
        formData.append('tool', 'vulnerability');
        
        const response = await fetch('api.php', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        console.log('Full API Response:', data); // Debug log
        
        document.getElementById('vuln-loading').style.display = 'none';
        
        if (data.error) {
            alert('Error: ' + data.error);
            return;
        }
        
        if (!data.success) {
            alert('Scan failed: ' + (data.message || 'Unknown error'));
            return;
        }
        
        document.getElementById('vuln-results').style.display = 'block';
        document.getElementById('vuln-btn').disabled = false;
        displayVulnerabilityResults(data);
        
    } catch (error) {
        document.getElementById('vuln-loading').style.display = 'none';
        document.getElementById('vuln-btn').disabled = false;
        console.error('Request failed:', error);
        alert('Request failed: ' + error.message);
    }
}

function displayVulnerabilityResults(results) {
    console.log('Raw results:', results);

    // Safely extract the actual data with proper error handling
    let data;

    // Handle the nested structure from the PHP response
    if (results && results.data && results.data.data) {
        // Nested structure: results.data.data
        data = results.data.data;
    } else if (results && results.data) {
        // Direct structure: results.data  
        data = results.data;
    } else if (results) {
        // Root level structure
        data = results;
    } else {
        console.error('Unexpected data structure:', results);
        alert('Error: Unexpected response format from server');
        return;
    }

    console.log('Processed data for display:', data);

    // Create the main results container
    const resultsContainer = document.getElementById('vuln-results');
    resultsContainer.innerHTML = '';

    // Check if we have professional format data
    if (data.categorized_findings && data.executive_summary) {
        displayProfessionalVulnerabilityResults(results);
    } else if (data.vulnerabilities !== undefined || data.scan_metrics) {
        // Use basic display for other formats
        displayBasicVulnerabilityResults(data);
    } else {
        // Fallback for any other structure
        console.warn('Using fallback display for data structure');
        displayBasicVulnerabilityResults(data);
    }
}

function displayBasicVulnerabilityResults(data) {
    const resultsContainer = document.getElementById('vuln-results');
    
    // Create header
    const header = document.createElement('header');
    header.className = 'header-vuln fade-in';

    const scanType = data.scan_type || 'quick';
    const scanTitles = {
        'quick': 'Quick Security Scan Results',
        'full': 'Full Comprehensive Security Scan Results',
        'cms': 'CMS-Specific Security Scan Results', 
        'api': 'API Endpoints Security Scan Results'
    };

    header.innerHTML = `
        <div class="header-content">
            <div class="logo-vuln">
                <i class="fas fa-shield-alt"></i>
                <span>${scanTitles[scanType] || 'Security Scan Results'}</span>
            </div>
            <div class="scan-info">
                <div class="scan-info-item">
                    <i class="fas fa-globe"></i>
                    <span>Target: ${data.website_info?.url || 'Unknown'}</span>
                </div>
                <div class="scan-info-item">
                    <i class="fas fa-calendar"></i>
                    <span>Scan Date: ${new Date().toLocaleDateString('en-GB')}</span>
                </div>
                <div class="scan-info-item">
                    <i class="fas fa-clock"></i>
                    <span>Duration: ${data.scan_metrics?.scan_duration || 'Unknown'}</span>
                </div>
            </div>
        </div>
    `;
    resultsContainer.appendChild(header);
    
    // Create main container
    const container = document.createElement('div');
    container.className = 'container slide-up';
    resultsContainer.appendChild(container);

    // Add Scan Metrics - FIXED CALCULATIONS
    if (data.scan_metrics) {
        const metricsSection = document.createElement('div');
        metricsSection.className = 'result-card';
        metricsSection.innerHTML = '<h3><i class="fas fa-chart-bar"></i> Scan Metrics</h3>';
        
        const metricsGrid = document.createElement('div');
        metricsGrid.className = 'metrics-grid';
        
        // Calculate actual test counts
        const totalTests = data.scan_metrics.total_tests || 0;
        const testsPassed = data.scan_metrics.tests_passed || 0;
        const testsFailed = data.scan_metrics.tests_failed || 0;
        const testsInfo = totalTests - (testsPassed + testsFailed); // Info/neutral tests
        
        metricsGrid.innerHTML = `
            <div class="metric-card">
                <div class="metric-value">${totalTests}</div>
                <div class="metric-label">Total Tests</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" style="color: #28a745;">${testsPassed}</div>
                <div class="metric-label">Tests Passed</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" style="color: #dc3545;">${testsFailed}</div>
                <div class="metric-label">Tests Failed</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" style="color: #17a2b8;">${testsInfo}</div>
                <div class="metric-label">Info Tests</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" style="color: #6c757d;">${data.scan_metrics.success_rate || 0}%</div>
                <div class="metric-label">Success Rate</div>
            </div>
        `;
        metricsSection.appendChild(metricsGrid);
        container.appendChild(metricsSection);
    }

    // Add summary cards - FIXED VULNERABILITY COUNT LOGIC
    const summaryCardsDiv = document.createElement('div');
    summaryCardsDiv.className = 'summary-cards-div';

    // Get vulnerabilities from the correct location
    const vulnerabilities = (data.vulnerabilities || []);
    const criticalCount = vulnerabilities.filter(v => v.severity?.toLowerCase() === 'critical').length;
    const highCount = vulnerabilities.filter(v => v.severity?.toLowerCase() === 'high').length;
    const mediumCount = vulnerabilities.filter(v => v.severity?.toLowerCase() === 'medium').length;
    const lowCount = vulnerabilities.filter(v => v.severity?.toLowerCase() === 'low').length;

    // Also check summary data if available
    const finalCritical = criticalCount;
    const finalHigh = highCount;
    const finalMedium = mediumCount;
    const finalLow = lowCount;

    summaryCardsDiv.innerHTML = `
        <div class="summary-card critical">
            <i class="fas fa-skull-crossbones fa-2x"></i>
            <div class="summary-count">${finalCritical}</div>
            <div class="summary-label">Critical</div>
        </div>
        <div class="summary-card high">
            <i class="fas fa-exclamation-triangle fa-2x"></i>
            <div class="summary-count">${finalHigh}</div>
            <div class="summary-label">High</div>
        </div>
        <div class="summary-card medium">
            <i class="fas fa-exclamation-circle fa-2x"></i>
            <div class="summary-count">${finalMedium}</div>
            <div class="summary-label">Medium</div>
        </div>
        <div class="summary-card low">
            <i class="fas fa-info-circle fa-2x"></i>
            <div class="summary-count">${finalLow}</div>
            <div class="summary-label">Low</div>
        </div>
    `;
    container.appendChild(summaryCardsDiv);
    
    // Add chart container - ONLY SHOW IF THERE ARE VULNERABILITIES
    if (finalCritical + finalHigh + finalMedium + finalLow > 0) {
        const chartContainer = document.createElement('div');
        chartContainer.className = 'chart-container fade-in';
        chartContainer.innerHTML = `
            <h3 class="chart-title"><i class="fas fa-chart-pie"></i> Vulnerability Distribution</h3>
            <div class="chart-wrapper">
                <canvas id="vuln-chart"></canvas>
            </div>
        `;
        container.appendChild(chartContainer);
        
        // Create chart
        setTimeout(() => {
            createVulnerabilityChart(finalCritical, finalHigh, finalMedium, finalLow);
        }, 100);
    }
    
    // Display Detailed Test Results - FIXED LOGIC
    // if (data.detailed_test_results && data.detailed_test_results.length > 0) {
    //     const testResultsCard = document.createElement('div');
    //     testResultsCard.className = 'result-card slide-up';
    //     testResultsCard.innerHTML = '<h3><i class="fas fa-tasks"></i> Detailed Test Results</h3>';
        
    //     // Add test summary
    //     const testSummary = document.createElement('div');
    //     testSummary.className = 'test-summary';
    //     testSummary.innerHTML = `
    //         <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
    //             <div><strong>Total Tests:</strong> ${data.detailed_test_results.length}</div>
    //             <div style="color: #28a745;"><strong>Passed:</strong> ${data.detailed_test_results.filter(t => t.status === 'success').length}</div>
    //             <div style="color: #dc3545;"><strong>Failed:</strong> ${data.detailed_test_results.filter(t => ['critical', 'high', 'medium', 'error'].includes(t.status)).length}</div>
    //             <div style="color: #17a2b8;"><strong>Info:</strong> ${data.detailed_test_results.filter(t => t.status === 'info').length}</div>
    //             <div style="color: #ffc107;"><strong>Warnings:</strong> ${data.detailed_test_results.filter(t => t.status === 'warning').length}</div>
    //         </div>
    //     `;
    //     testResultsCard.appendChild(testSummary);
        
    //     const testResultsSection = document.createElement('div');
    //     testResultsSection.className = 'test-results-section';
        
    //     // Sort tests by severity for better organization
    //     const severityOrder = {
    //         'critical': 1,
    //         'high': 2, 
    //         'medium': 3,
    //         'error': 4,
    //         'warning': 5,
    //         'info': 6,
    //         'success': 7
    //     };
        
    //     const sortedTests = [...data.detailed_test_results].sort((a, b) => {
    //         return (severityOrder[a.status] || 8) - (severityOrder[b.status] || 8);
    //     });
        
    //     sortedTests.forEach(test => {
    //         const testEl = document.createElement('div');
    //         testEl.className = 'test-item';
    //         testEl.innerHTML = `
    //             <div class="test-status ${test.status}"></div>
    //             <div class="test-content">
    //                 <div class="test-name">${test.name}</div>
    //                 <div class="test-details">${test.details || 'Test completed'}</div>
    //             </div>
    //             <div class="test-timestamp">${test.timestamp}</div>
    //         `;
    //         testResultsSection.appendChild(testEl);
    //     });
        
    //     testResultsCard.appendChild(testResultsSection);
    //     container.appendChild(testResultsCard);
    // }

    if (data.test_results && data.test_results.length > 0) {
    const testResultsCard = document.createElement('div');
    testResultsCard.className = 'result-card slide-up';
    testResultsCard.innerHTML = '<h3><i class="fas fa-tasks"></i> Test Execution Results</h3>';
    
    // Group tests by category
    const testsByCategory = {};
    data.test_results.forEach(test => {
        const category = test.name.split(' ')[0] || 'General';
        if (!testsByCategory[category]) {
            testsByCategory[category] = [];
        }
        testsByCategory[category].push(test);
    });
    
    // Create accordion for each category
    Object.entries(testsByCategory).forEach(([category, tests]) => {
        const categorySection = document.createElement('div');
        categorySection.className = 'test-category';
        categorySection.innerHTML = `
            <div class="category-header">
                <h4>${category} (${tests.length} tests)</h4>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="category-tests" style="display: none;">
                ${tests.map(test => `
                    <div class="test-item ${test.status}">
                        <div class="test-icon">
                            <i class="fas fa-${getTestStatusIcon(test.status)}"></i>
                        </div>
                        <div class="test-details">
                            <div class="test-name">${test.name}</div>
                            <div class="test-description">${test.details || 'Test completed'}</div>
                            <div class="test-time">${test.timestamp || ''}</div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
        
        categorySection.querySelector('.category-header').addEventListener('click', function() {
            const testsDiv = this.nextElementSibling;
            const icon = this.querySelector('i');
            if (testsDiv.style.display === 'none') {
                testsDiv.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
            } else {
                testsDiv.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
            }
        });
        
        testResultsCard.appendChild(categorySection);
    });
    
    container.appendChild(testResultsCard);
}

    // Create vulnerabilities result card - FIXED LOGIC
    const hasVulnerabilities = vulnerabilities.length > 0 || (finalCritical + finalHigh + finalMedium + finalLow) > 0;
    
    if (hasVulnerabilities) {
        const vulnCard = document.createElement('div');
        vulnCard.className = 'result-card slide-up';
        vulnCard.innerHTML = '<h3><i class="fas fa-bug"></i> Security Vulnerabilities</h3>';
        container.appendChild(vulnCard);
        
        const vulnList = document.createElement('div');
        vulnList.id = 'vulnerabilities-list';
        vulnCard.appendChild(vulnList);
        
        // Display vulnerabilities
        if (vulnerabilities.length > 0) {
            vulnerabilities.forEach(vuln => {
                const vulnEl = document.createElement('div');
                vulnEl.className = `vuln-item ${vuln.severity ? vuln.severity.toLowerCase() : 'unknown'} fade-in`;
                
                // Format CVSS score
                const cvssScore = vuln.cvss_score || 0.0;
                const cvssDisplay = cvssScore > 0 ? cvssScore.toFixed(1) : 'N/A';
                
                vulnEl.innerHTML = `
                    <div class="vuln-header">
                        <span class="risk-badge risk-${vuln.severity ? vuln.severity.toLowerCase() : 'unknown'}">
                            ${vuln.severity ? vuln.severity.toUpperCase() : 'UNKNOWN'}
                        </span>
                        <span class="cvss-score" title="CVSS ${cvssDisplay}">CVSS: ${cvssDisplay}</span>
                    </div>
                    <h4>${vuln.type || 'Unknown Type'}</h4>
                    <p class="vuln-description">${vuln.description || 'No description available'}</p>
                    <div class="vuln-details">
                        <div><strong>Location:</strong> ${vuln.location || 'Not specified'}</div>
                        <div><strong>Impact:</strong> ${vuln.impact || 'Not specified'}</div>
                        <div><strong>Category:</strong> ${vuln.category || 'general'}</div>
                        ${vuln.evidence ? `<div><strong>Evidence:</strong> ${vuln.evidence}</div>` : ''}
                    </div>
                    <div class="remediation">
                        <strong>Remediation:</strong> ${vuln.remediation || 'No remediation provided'}
                    </div>
                    ${vuln.cves && vuln.cves.length > 0 ? `
                        <div class="cve-list">
                            <strong>CVEs:</strong>
                            <div class="cve-tags">
                                ${vuln.cves.slice(0, 3).map(cve => `
                                    <span class="cve-tag" onclick="window.open('https://nvd.nist.gov/vuln/detail/${cve}', '_blank')">
                                        ${cve}
                                    </span>
                                `).join('')}
                                ${vuln.cves.length > 3 ? `<span class="cve-more">+${vuln.cves.length - 3} more</span>` : ''}
                            </div>
                        </div>
                    ` : ''}
                    <div class="vuln-actions">
                        <button class="btn-ai-fix" onclick="openAIFixModalFromCard('${encodeURIComponent(JSON.stringify(vuln))}')">
                            <i class="fas fa-robot"></i> AI-Powered Fix
                        </button>
                    </div>
                `;
                vulnList.appendChild(vulnEl);
            });
        } else {
            // If no vulnerabilities array but we have counts from summary
            vulnList.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: var(--text-light);">
                    <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                    <p>Vulnerabilities detected but detailed information not available. Check the detailed test results above.</p>
                </div>
            `;
        }
    } else {
        // Only show "No Vulnerabilities" if truly none were found
        const noVulnCard = document.createElement('div');
        noVulnCard.className = 'result-card slide-up';
        noVulnCard.innerHTML = `
            <div style="text-align: center; padding: 3rem;">
                <i class="fas fa-check-circle" style="font-size: 4rem; color: #28a745; margin-bottom: 1rem;"></i>
                <h3 style="color: #28a745;">No Security Vulnerabilities Found</h3>
                <p style="color: var(--text-light);">
                    The security scan completed successfully. 
                    ${data.scan_metrics?.tests_failed ? `${data.scan_metrics.tests_failed} security issues were found but they are classified as informational or low risk.` : 'No security issues were detected.'}
                </p>
                ${data.scan_metrics?.tests_failed ? `
                    <div style="margin-top: 1rem; padding: 1rem; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <strong>Note:</strong> While no critical vulnerabilities were found, some security improvements are recommended. 
                        Check the "Detailed Test Results" section for specific recommendations.
                    </div>
                ` : ''}
            </div>
        `;
        container.appendChild(noVulnCard);
    }
    
    // Display full scan details if available
    if (scanType === 'full' && data.full_scan_details) {
        displayFullScanDetails(data.full_scan_details, container);
    }

    // Display recommendations if available
    if (data.recommendations && data.recommendations.length > 0) {
        const recommendationsCard = document.createElement('div');
        recommendationsCard.className = 'result-card slide-up';
        recommendationsCard.innerHTML = '<h3><i class="fas fa-lightbulb"></i> Security Recommendations</h3>';
        container.appendChild(recommendationsCard);
        
        const recommendationsSection = document.createElement('div');
        recommendationsSection.className = 'scan-detail-section';
        recommendationsCard.appendChild(recommendationsSection);
        
        const recommendationsList = document.createElement('ul');
        recommendationsList.className = 'recommendations-list';
        
        data.recommendations.forEach(rec => {
            const recEl = document.createElement('li');
            recEl.className = 'fade-in';
            recEl.innerHTML = `<i class="fas fa-chevron-right"></i> ${rec}`;
            recommendationsList.appendChild(recEl);
        });
        recommendationsSection.appendChild(recommendationsList);
    }

    createScanIntelligenceSection(data, vulnerabilities, container);
    addDownloadButtons(container, data);

    // Add scan metadata
    const metaSection = document.createElement('div');
    metaSection.className = 'scan-meta-section';
    metaSection.innerHTML = `
        <div class="scan-meta" style="text-align: center; padding: 1rem; color: var(--text-light); font-size: 0.9rem;">
            <span><i class="fas fa-info-circle"></i> Scan completed at ${new Date().toLocaleString()}</span>
        </div>
    `;
    container.appendChild(metaSection);
}

function getTestStatusIcon(status) {
    const icons = {
        'success': 'check-circle',
        'info': 'info-circle',
        'warning': 'exclamation-triangle',
        'error': 'exclamation-circle',
        'critical': 'skull-crossbones',
        'high': 'exclamation-triangle',
        'medium': 'exclamation-circle',
        'low': 'info-circle'
    };
    return icons[status] || 'question-circle';
}

function createVulnerabilityChart(critical, high, medium, low) {
    const ctx = document.getElementById('vuln-chart').getContext('2d');
    
    // Destroy existing chart if it exists
    if (window.vulnChart instanceof Chart) {
        window.vulnChart.destroy();
    }

    window.vulnChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Critical', 'High', 'Medium', 'Low'],
            datasets: [{
                data: [critical, high, medium, low],
                backgroundColor: ['#dc2626', '#ea580c', '#d97706', '#65a30d'],
                borderColor: ['#fff', '#fff', '#fff', '#fff'],
                borderWidth: 2,
                hoverOffset: 15
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: {
                    top: 20,
                    bottom: 20
                }
            },
            plugins: {
                legend: { 
                    position: 'bottom',
                    labels: {
                        color: '#212529',
                        font: {
                            size: 12,
                            weight: 'bold'
                        },
                        padding: 20
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            },
            animation: {
                animateScale: true,
                animateRotate: true
            }
        }
    });
}

// Function to display additional full scan details
function displayFullScanDetails(details, container) {
    const fullScanCard = document.createElement('div');
    fullScanCard.className = 'result-card slide-up';
    fullScanCard.innerHTML = '<h3><i class="fas fa-search-plus"></i> Full Scan Details</h3>';
    container.appendChild(fullScanCard);

    let fullScanContent = '';

    if (details.comprehensive_analysis) {
        fullScanContent += `
            <div class="scan-detail-section">
                <h4><i class="fas fa-check-circle"></i> Comprehensive Analysis</h4>
                <p>This scan performed ${details.tests_performed || '100+'} security checks with ${details.scan_intensity || 'High'} intensity.</p>
                <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e6f3ff 100%); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                    <strong>Scan Coverage:</strong> ${details.scan_coverage || 'Comprehensive security assessment'}
                </div>
            </div>
        `;
    }

    // Add technology stack analysis if available
    if (details.technology_stack) {
        fullScanContent += `
            <div class="scan-detail-section">
                <h4><i class="fas fa-layer-group"></i> Technology Stack Analysis</h4>
                <div class="tech-items">
                    ${Object.entries(details.technology_stack).map(([category, items]) => `
                        ${Array.isArray(items) && items.length > 0 ? `
                            <div style="margin-bottom: 1rem;">
                                <strong>${category.replace(/_/g, ' ').toUpperCase()}:</strong>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                                    ${items.map(item => `<span class="tech-item">${item}</span>`).join('')}
                                </div>
                            </div>
                        ` : ''}
                    `).join('')}
                </div>
            </div>
        `;
    }

    // Add port scanning results if available
    if (details.open_ports && details.open_ports.length > 0) {
        fullScanContent += `
            <div class="scan-detail-section">
                <h4><i class="fas fa-network-wired"></i> Port Scanning Results</h4>
                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                    ${details.open_ports.map(port => `
                        <span style="background: ${port.status === 'open' ? '#dc2626' : '#65a30d'}; color: white; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.8rem;">
                            Port ${port.port} (${port.service || 'Unknown'})
                        </span>
                    `).join('')}
                </div>
            </div>
        `;
    }

    fullScanCard.innerHTML += fullScanContent;
}

// Function to display technology stack analysis
function displayTechnologyStackAnalysis(techStack, vulnList) {
    const techEl = document.createElement('div');
    techEl.className = 'scan-detail-section technology-stack';
    
    let techContent = '<h4><i class="fas fa-layer-group"></i> Technology Stack Analysis</h4>';
    
    // Web Server
    if (techStack.web_server && techStack.web_server.length > 0) {
        techContent += `
            <div class="tech-category">
                <h5><i class="fas fa-server"></i> Web Server</h5>
                <div class="tech-items">
                    ${techStack.web_server.map(server => `<span class="tech-item">${server}</span>`).join('')}
                </div>
            </div>
        `;
    }
    
    // Programming Languages
    if (techStack.programming_languages && techStack.programming_languages.length > 0) {
        techContent += `
            <div class="tech-category">
                <h5><i class="fas fa-code"></i> Programming Languages</h5>
                <div class="tech-items">
                    ${techStack.programming_languages.map(lang => `<span class="tech-item">${lang}</span>`).join('')}
                </div>
            </div>
        `;
    }
    
    // Frameworks
    if (techStack.frameworks && techStack.frameworks.length > 0) {
        techContent += `
            <div class="tech-category">
                <h5><i class="fas fa-cubes"></i> Frameworks</h5>
                <div class="tech-items">
                    ${techStack.frameworks.map(framework => `<span class="tech-item">${framework}</span>`).join('')}
                </div>
            </div>
        `;
    }
    
    // Database Technologies
    if (techStack.database_technologies && techStack.database_technologies.length > 0) {
        techContent += `
            <div class="tech-category">
                <h5><i class="fas fa-database"></i> Database Technologies</h5>
                <div class="tech-items">
                    ${techStack.database_technologies.map(db => `<span class="tech-item">${db}</span>`).join('')}
                </div>
            </div>
        `;
    }
    
    // Caching Technologies
    if (techStack.caching_technologies && techStack.caching_technologies.length > 0) {
        techContent += `
            <div class="tech-category">
                <h5><i class="fas fa-bolt"></i> Caching Technologies</h5>
                <div class="tech-items">
                    ${techStack.caching_technologies.map(cache => `<span class="tech-item">${cache}</span>`).join('')}
                </div>
            </div>
        `;
    }
    
    // CDN Providers
    if (techStack.cdn_providers && techStack.cdn_providers.length > 0) {
        techContent += `
            <div class="tech-category">
                <h5><i class="fas fa-cloud"></i> CDN Providers</h5>
                <div class="tech-items">
                    ${techStack.cdn_providers.map(cdn => `<span class="tech-item">${cdn}</span>`).join('')}
                </div>
            </div>
        `;
    }
    
    // Version Information
    if (techStack.version_information && Object.keys(techStack.version_information).length > 0) {
        techContent += `
            <div class="tech-category">
                <h5><i class="fas fa-info-circle"></i> Version Information</h5>
                <div class="version-items">
                    ${Object.entries(techStack.version_information).map(([tech, version]) => 
                        `<div class="version-item"><strong>${tech}:</strong> ${Array.isArray(version) ? version.join(', ') : version}</div>`
                    ).join('')}
                </div>
            </div>
        `;
    }
    
    // Security Implications
    if (techStack.security_implications && techStack.security_implications.length > 0) {
        techContent += `
            <div class="tech-category security-implications">
                <h5><i class="fas fa-shield-alt"></i> Security Implications</h5>
                <div class="implication-items">
                    ${techStack.security_implications.map(implication => 
                        `<div class="implication-item"><i class="fas fa-exclamation-triangle"></i> ${implication}</div>`
                    ).join('')}
                </div>
            </div>
        `;
    }
    
    techEl.innerHTML = techContent;
    vulnList.appendChild(techEl);
}

// Function to display directory enumeration results
function displayDirectoryEnumerationResults(enumeration, vulnList) {
    const enumEl = document.createElement('div');
    enumEl.className = 'scan-detail-section directory-enumeration';
    
    let enumContent = '<h4><i class="fas fa-folder-tree"></i> Directory & File Enumeration</h4>';
    
    // Common Directories
    if (enumeration.common_directories && enumeration.common_directories.length > 0) {
        enumContent += `
            <div class="enum-category">
                <h5><i class="fas fa-folder"></i> Common Directories Found</h5>
                <div class="enum-items">
                    ${enumeration.common_directories.map(dir => `
                        <div class="enum-item ${dir.risk || 'low'}">
                            <span class="enum-path">${dir.path}</span>
                            <span class="enum-status">${dir.status}</span>
                            ${dir.risk ? `<span class="risk-indicator risk-${dir.risk}">${dir.risk.toUpperCase()}</span>` : ''}
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    // Hidden Files
    if (enumeration.hidden_files && enumeration.hidden_files.length > 0) {
        enumContent += `
            <div class="enum-category">
                <h5><i class="fas fa-eye-slash"></i> Hidden Files Found</h5>
                <div class="enum-items">
                    ${enumeration.hidden_files.map(file => `
                        <div class="enum-item ${file.risk || 'medium'}">
                            <span class="enum-path">${file.path}</span>
                            <span class="enum-status">${file.status}</span>
                            ${file.risk ? `<span class="risk-indicator risk-${file.risk}">${file.risk.toUpperCase()}</span>` : ''}
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    // Backup Files
    if (enumeration.backup_files && enumeration.backup_files.length > 0) {
        enumContent += `
            <div class="enum-category">
                <h5><i class="fas fa-archive"></i> Backup Files Found</h5>
                <div class="enum-items">
                    ${enumeration.backup_files.map(backup => `
                        <div class="enum-item ${backup.risk || 'high'}">
                            <span class="enum-path">${backup.path}</span>
                            <span class="enum-status">${backup.status}</span>
                            <span class="risk-indicator risk-${backup.risk || 'high'}">${(backup.risk || 'high').toUpperCase()}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    // Config Files
    if (enumeration.config_files && enumeration.config_files.length > 0) {
        enumContent += `
            <div class="enum-category">
                <h5><i class="fas fa-cog"></i> Configuration Files Found</h5>
                <div class="enum-items">
                    ${enumeration.config_files.map(config => `
                        <div class="enum-item ${config.risk || 'critical'}">
                            <span class="enum-path">${config.path}</span>
                            <span class="enum-status">${config.status}</span>
                            <span class="risk-indicator risk-${config.risk || 'critical'}">CRITICAL</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    // Log Files
    if (enumeration.log_files && enumeration.log_files.length > 0) {
        enumContent += `
            <div class="enum-category">
                <h5><i class="fas fa-clipboard-list"></i> Log Files Found</h5>
                <div class="enum-items">
                    ${enumeration.log_files.map(log => `
                        <div class="enum-item ${log.risk || 'high'}">
                            <span class="enum-path">${log.path}</span>
                            <span class="enum-status">${log.status}</span>
                            <span class="risk-indicator risk-${log.risk || 'high'}">HIGH</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    // Admin Interfaces
    if (enumeration.admin_interfaces && enumeration.admin_interfaces.length > 0) {
        enumContent += `
            <div class="enum-category">
                <h5><i class="fas fa-user-shield"></i> Admin Interfaces Found</h5>
                <div class="enum-items">
                    ${enumeration.admin_interfaces.map(admin => `
                        <div class="enum-item ${admin.risk || 'medium'}">
                            <span class="enum-path">${admin.path}</span>
                            <span class="enum-status">${admin.status}</span>
                            <span class="risk-indicator risk-${admin.risk || 'medium'}">MEDIUM</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    // Summary statistics
    const totalFound = [
        ...(enumeration.common_directories || []),
        ...(enumeration.hidden_files || []),
        ...(enumeration.backup_files || []),
        ...(enumeration.config_files || []),
        ...(enumeration.log_files || []),
        ...(enumeration.admin_interfaces || [])
    ].length;
    
    if (totalFound > 0) {
        enumContent += `
            <div class="enum-summary">
                <strong>Total items found:</strong> ${totalFound}
            </div>
        `;
    } else {
        enumContent += `
            <div class="no-enumeration">
                <i class="fas fa-check-circle"></i> No sensitive directories or files found
            </div>
        `;
    }
    
    enumEl.innerHTML = enumContent;
    vulnList.appendChild(enumEl);
}

// Add this function to create the intelligence section
function createScanIntelligenceSection(data, vulnerabilities, container) {
    const intelligenceCard = document.createElement('div');
    intelligenceCard.className = 'result-card intelligence-section slide-up';
    
    // Calculate metrics
    const totalTests = data.scan_metrics?.total_tests || 0;
    const testsPassed = data.scan_metrics?.tests_passed || 0;
    const testsFailed = data.scan_metrics?.tests_failed || 0;
    const infoTests = totalTests - (testsPassed + testsFailed);
    const successRate = data.scan_metrics?.success_rate || 0;
    
    // Count vulnerabilities by severity
    const criticalCount = vulnerabilities.filter(v => v.severity?.toLowerCase() === 'critical').length;
    const highCount = vulnerabilities.filter(v => v.severity?.toLowerCase() === 'high').length;
    const mediumCount = vulnerabilities.filter(v => v.severity?.toLowerCase() === 'medium').length;
    const lowCount = vulnerabilities.filter(v => v.severity?.toLowerCase() === 'low').length;
    
    const totalVulnerabilities = criticalCount + highCount + mediumCount + lowCount;
    
    intelligenceCard.innerHTML = `
        <h3><i class="fas fa-brain"></i> Scan Intelligence & Analysis</h3>
        
        <div class="intelligence-grid">
            <!-- Executive Summary -->
            <div class="intelligence-card executive-summary">
                <h4><i class="fas fa-chart-line"></i> Executive Summary</h4>
                <div class="summary-content">
                    ${criticalCount > 0 ? `
                        <div class="alert critical-alert">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Critical Risk:</strong> ${criticalCount} immediate threats found that require emergency attention
                        </div>
                    ` : `
                        <div class="alert success-alert">
                            <i class="fas fa-check-circle"></i>
                            <strong>No Critical Vulnerabilities:</strong> No immediate system-compromising issues detected
                        </div>
                    `}
                    
                    ${highCount > 0 ? `
                        <div class="alert high-alert">
                            <i class="fas fa-exclamation-circle"></i>
                            <strong>High Priority:</strong> ${highCount} serious vulnerabilities need urgent remediation
                        </div>
                    ` : ''}
                    
                    <div class="summary-stats">
                        <div class="stat-item">
                            <span class="stat-value">${totalVulnerabilities}</span>
                            <span class="stat-label">Total Security Issues</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">${testsPassed}</span>
                            <span class="stat-label">Security Controls Working</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Test Analysis -->
            <div class="intelligence-card test-analysis">
                <h4><i class="fas fa-flask"></i> Test Execution Analysis</h4>
                <div class="analysis-content">
                    <div class="metric-breakdown">
                        <div class="metric">
                            <span class="metric-label">Total Security Checks:</span>
                            <span class="metric-value">${totalTests}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Security Tests Passed:</span>
                            <span class="metric-value" style="color: #28a745;">${testsPassed}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Security Issues Found:</span>
                            <span class="metric-value" style="color: #dc3545;">${testsFailed}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Information Gathered:</span>
                            <span class="metric-value" style="color: #17a2b8;">${infoTests}</span>
                        </div>
                    </div>
                    
                    <div class="success-context">
                        <i class="fas fa-info-circle"></i>
                        <strong>Success Rate Context:</strong> ${successRate.toFixed(1)}% is normal for security scans as they're designed to find problems.
                    </div>
                </div>
            </div>
            
            <!-- Vulnerability Breakdown -->
            <div class="intelligence-card vulnerability-breakdown">
                <h4><i class="fas fa-shield-alt"></i> Vulnerability Severity Analysis</h4>
                <div class="severity-content">
                    ${criticalCount > 0 ? `
                        <div class="severity-item critical">
                            <div class="severity-header">
                                <i class="fas fa-skull-crossbones"></i>
                                <span class="severity-title">Critical (${criticalCount})</span>
                                <span class="severity-badge">EMERGENCY</span>
                            </div>
                            <div class="severity-desc">
                                Immediate system-compromising vulnerabilities. Drop everything and fix these first.
                                <div class="examples">
                                    <strong>Examples:</strong> Remote code execution, authentication bypass, complete data compromise
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${highCount > 0 ? `
                        <div class="severity-item high">
                            <div class="severity-header">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span class="severity-title">High (${highCount})</span>
                                <span class="severity-badge">URGENT</span>
                            </div>
                            <div class="severity-desc">
                                Serious vulnerabilities that could lead to significant data loss or system access.
                                <div class="examples">
                                    <strong>Examples:</strong> SQL injection, sensitive data exposure, privilege escalation
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${mediumCount > 0 ? `
                        <div class="severity-item medium">
                            <div class="severity-header">
                                <i class="fas fa-exclamation-circle"></i>
                                <span class="severity-title">Medium (${mediumCount})</span>
                                <span class="severity-badge">IMPORTANT</span>
                            </div>
                            <div class="severity-desc">
                                Important security issues that should be addressed in the next development cycle.
                                <div class="examples">
                                    <strong>Examples:</strong> Cross-site scripting, CSRF, security misconfigurations
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${lowCount > 0 ? `
                        <div class="severity-item low">
                            <div class="severity-header">
                                <i class="fas fa-info-circle"></i>
                                <span class="severity-title">Low (${lowCount})</span>
                                <span class="severity-badge">ENHANCEMENT</span>
                            </div>
                            <div class="severity-desc">
                                Minor security improvements that can be handled during routine maintenance.
                                <div class="examples">
                                    <strong>Examples:</strong> Missing security headers, information disclosure, version exposure
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
            
            <!-- Action Plan -->
            <div class="intelligence-card action-plan">
                <h4><i class="fas fa-rocket"></i> Recommended Action Plan</h4>
                <div class="action-content">
                    <div class="timeline">
                        ${criticalCount > 0 ? `
                            <div class="timeline-item immediate">
                                <div class="timeline-marker" style="background: #dc2626;"></div>
                                <div class="timeline-content">
                                    <h5>IMMEDIATE (0-24 hours)</h5>
                                    <p>Fix <strong>${criticalCount} critical</strong> vulnerabilities - these pose existential threats</p>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${highCount > 0 ? `
                            <div class="timeline-item urgent">
                                <div class="timeline-marker" style="background: #ea580c;"></div>
                                <div class="timeline-content">
                                    <h5>URGENT (1-7 days)</h5>
                                    <p>Address <strong>${highCount} high-severity</strong> vulnerabilities</p>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${mediumCount > 0 ? `
                            <div class="timeline-item important">
                                <div class="timeline-marker" style="background: #d97706;"></div>
                                <div class="timeline-content">
                                    <h5>IMPORTANT (2-4 weeks)</h5>
                                    <p>Resolve <strong>${mediumCount} medium-severity</strong> issues in next sprint</p>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${lowCount > 0 ? `
                            <div class="timeline-item enhancement">
                                <div class="timeline-marker" style="background: #65a30d;"></div>
                                <div class="timeline-content">
                                    <h5>ENHANCEMENT (Next quarter)</h5>
                                    <p>Implement <strong>${lowCount} low-severity</strong> improvements</p>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${totalVulnerabilities === 0 ? `
                            <div class="timeline-item all-clear">
                                <div class="timeline-marker" style="background: #28a745;"></div>
                                <div class="timeline-content">
                                    <h5>EXCELLENT SECURITY POSTURE</h5>
                                    <p>No vulnerabilities found! Maintain current security practices and schedule regular scans.</p>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Key Insights -->
        <div class="key-insights">
            <h4><i class="fas fa-lightbulb"></i> Key Insights</h4>
            <div class="insights-grid">
                <div class="insight-item">
                    <i class="fas fa-search"></i>
                    <div class="insight-content">
                        <strong>Scan Depth:</strong> ${totalTests} comprehensive security checks performed
                    </div>
                </div>
                <div class="insight-item">
                    <i class="fas fa-clock"></i>
                    <div class="insight-content">
                        <strong>Response Time:</strong> ${criticalCount > 0 ? 'EMERGENCY response needed' : highCount > 0 ? 'Urgent attention required' : 'Standard security maintenance'}
                    </div>
                </div>
                <div class="insight-item">
                    <i class="fas fa-chart-pie"></i>
                    <div class="insight-content">
                        <strong>Risk Distribution:</strong> ${criticalCount > 0 ? 'Critical risk present' : highCount > 0 ? 'High risk focus' : 'Moderate to low risk profile'}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.appendChild(intelligenceCard);
}

// Add download buttons to the results section
function addDownloadButtons(container, scanData) {
    const downloadSection = document.createElement('div');
    downloadSection.className = 'download-section';
    
    // Escape the JSON data properly for HTML attributes
    const escapedData = JSON.stringify(scanData).replace(/"/g, '&quot;');
    
    downloadSection.innerHTML = `
        <div class="download-buttons">
            <button class="btn-download pdf-download" data-scan-data="${escapedData}">
                <i class="fas fa-file-pdf"></i> Download PDF Report
            </button>
        </div>
        <div class="download-info">
            <i class="fas fa-info-circle"></i>
            Reports include all scan metrics, vulnerabilities, and detailed findings
        </div>
    `;
    
    // Add event listeners properly
    const pdfBtn = downloadSection.querySelector('.pdf-download');
    
    pdfBtn.addEventListener('click', (e) => downloadPDFReport(e, scanData));
    
    container.appendChild(downloadSection);
}

async function downloadPDFReport(event, scanData) {
    // Check if jsPDF is loaded
    if (typeof jspdf === 'undefined' || !jspdf.jsPDF) {
        alert('PDF library not loaded. Please refresh the page and try again.');
        return;
    }
    
    // If scanData is not passed, try to get it from the event target
    if (!scanData && event && event.currentTarget) {
        const dataAttr = event.currentTarget.getAttribute('data-scan-data');
        if (dataAttr) {
            scanData = JSON.parse(dataAttr.replace(/&quot;/g, '"'));
        }
    }
    
    try {
        if (!scanData) {
            throw new Error('No scan data available. Please run a scan first.');
        }

        // Get the button reference safely
        let btn = null;
        if (event && event.currentTarget) {
            btn = event.currentTarget;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
            btn.disabled = true;
        }

        // Extract data from the correct structure
        let data;
        if (scanData.data && scanData.data.data) {
            data = scanData.data.data;
        } else if (scanData.data) {
            data = scanData.data;
        } else {
            data = scanData;
        }

        const vulnerabilities = data.vulnerabilities || [];
        const scanMetrics = data.scan_metrics || {};
        const websiteInfo = data.website_info || {};
        const testResults = data.detailed_test_results || [];
        const scanType = data.scan_type || 'Quick Scan';

        console.log('PDF Data Received:', { 
            vulnerabilities, 
            scanMetrics, 
            websiteInfo, 
            testResults 
        });

        const { jsPDF } = window.jspdf;
        
        // Check if jsPDF is available
        if (!jsPDF) {
            throw new Error('PDF library not loaded. Please check if jsPDF is included.');
        }
        
        const doc = new jsPDF();
        
        // Page dimensions
        const pageWidth = doc.internal.pageSize.width;
        const pageHeight = doc.internal.pageSize.height;
        const margin = 20;
        const contentWidth = pageWidth - (margin * 2);
        
        // Helper function to safely convert any value to string
        const safeString = (value) => {
            if (value === null || value === undefined) return 'N/A';
            return String(value);
        };

        // Helper function to safely add text with proper formatting
        const safeText = (text, x, y, options = {}) => {
            const textStr = safeString(text);
            doc.text(textStr, x, y, options);
            return doc.getTextDimensions(textStr, options);
        };

        // Helper function to add section title
        const addSectionTitle = (title, y) => {
            doc.setFillColor(59, 130, 246);
            doc.rect(margin - 5, y - 8, contentWidth + 10, 12, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            safeText(title, margin, y);
            doc.setTextColor(0, 0, 0);
            return y + 15;
        };

        // Helper function to check for new page
        const checkNewPage = (requiredSpace = 50) => {
            if (yPosition > pageHeight - requiredSpace) {
                doc.addPage();
                yPosition = margin;
                return true;
            }
            return false;
        };

        // Add watermark and styling
        doc.setFillColor(245, 247, 250);
        doc.rect(0, 0, pageWidth, pageHeight, 'F');
        
        // Header with gradient effect
        doc.setFillColor(59, 130, 246);
        doc.rect(0, 0, pageWidth, 60, 'F');
        
        // Logo and title
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(20);
        doc.setFont('helvetica', 'bold');
        safeText('SECURITY SCAN REPORT', pageWidth / 2, 30, { align: 'center' });
        
        doc.setFontSize(12);
        doc.setFont('helvetica', 'normal');
        safeText('Comprehensive Vulnerability Assessment', pageWidth / 2, 45, { align: 'center' });
        
        let yPosition = 80;

        // Executive Summary Section
        yPosition = addSectionTitle('EXECUTIVE SUMMARY', yPosition);
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        
        const criticalCount = vulnerabilities.filter(v => v.severity === 'critical').length;
        const highCount = vulnerabilities.filter(v => v.severity === 'high').length;
        const mediumCount = vulnerabilities.filter(v => v.severity === 'medium').length;
        const lowCount = vulnerabilities.filter(v => v.severity === 'low').length;
        
        // Risk level assessment
        let riskLevel, riskColor;
        if (criticalCount > 0) {
            riskLevel = 'CRITICAL RISK';
            riskColor = [220, 38, 38];
        } else if (highCount > 0) {
            riskLevel = 'HIGH RISK';
            riskColor = [234, 88, 12];
        } else if (mediumCount > 0) {
            riskLevel = 'MEDIUM RISK';
            riskColor = [217, 119, 6];
        } else if (lowCount > 0) {
            riskLevel = 'LOW RISK';
            riskColor = [101, 163, 13];
        } else {
            riskLevel = 'EXCELLENT SECURITY';
            riskColor = [40, 167, 69];
        }
        
        // Risk level box
        doc.setFillColor(...riskColor);
        doc.rect(margin, yPosition, contentWidth, 15, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        safeText(riskLevel, pageWidth / 2, yPosition + 10, { align: 'center' });
        
        yPosition += 25;
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        
        // Vulnerability summary in a clean table format
        const vulnSummary = [
            { label: 'Critical Vulnerabilities', count: criticalCount, color: [220, 38, 38] },
            { label: 'High Severity Issues', count: highCount, color: [234, 88, 12] },
            { label: 'Medium Severity Issues', count: mediumCount, color: [217, 119, 6] },
            { label: 'Low Severity Issues', count: lowCount, color: [101, 163, 13] },
            { label: 'Total Vulnerabilities', count: vulnerabilities.length, color: [59, 130, 246] }
        ];
        
        vulnSummary.forEach((item, index) => {
            if (checkNewPage(30)) yPosition = margin + 15;
            
            doc.setFillColor(...item.color);
            doc.rect(margin, yPosition, 5, 5, 'F');
            
            doc.setTextColor(0, 0, 0);
            safeText(item.label, margin + 10, yPosition + 4);
            
            doc.setFont('helvetica', 'bold');
            safeText(item.count.toString(), margin + contentWidth - 10, yPosition + 4, { align: 'right' });
            doc.setFont('helvetica', 'normal');
            
            yPosition += 8;
        });
        
        yPosition += 10;

        // Scan Information Section
        checkNewPage(100);
        yPosition = addSectionTitle('SCAN INFORMATION', yPosition);
        
        // Create a clean two-column layout for scan info
        const scanInfoLeft = [
            ['Target URL:', websiteInfo.url || 'N/A'],
            ['Scan Date:', scanMetrics.scan_timestamp || new Date().toLocaleDateString()],
            ['Scan Type:', scanType],
            ['Total Tests:', safeString(scanMetrics.total_tests || testResults.length || 0)]
        ];
        
        const scanInfoRight = [
            ['Tests Passed:', safeString(scanMetrics.tests_passed || testResults.filter(t => t.status === 'success').length || 0)],
            ['Tests Failed:', safeString(scanMetrics.tests_failed || testResults.filter(t => ['critical', 'high', 'medium', 'low', 'error'].includes(t.status)).length || 0)],
            ['Success Rate:', `${safeString(scanMetrics.success_rate || 0)}%`],
            ['Duration:', scanMetrics.scan_duration || 'N/A']
        ];
        
        const leftColumnX = margin;
        const rightColumnX = margin + contentWidth / 2 + 10;
        const startY = yPosition;
        
        scanInfoLeft.forEach(([label, value], index) => {
            const currentY = startY + (index * 7);
            doc.setFont('helvetica', 'bold');
            safeText(label, leftColumnX, currentY);
            doc.setFont('helvetica', 'normal');
            safeText(value, leftColumnX + 40, currentY);
        });
        
        scanInfoRight.forEach(([label, value], index) => {
            const currentY = startY + (index * 7);
            doc.setFont('helvetica', 'bold');
            safeText(label, rightColumnX, currentY);
            doc.setFont('helvetica', 'normal');
            safeText(value, rightColumnX + 40, currentY);
        });
        
        yPosition = startY + (Math.max(scanInfoLeft.length, scanInfoRight.length) * 7) + 15;

        // Vulnerability Chart Section - Create a proper chart instead of trying to capture the canvas
        checkNewPage(150);
        yPosition = addSectionTitle('VULNERABILITY DISTRIBUTION', yPosition);
        
        // Create a proper bar chart representation since canvas capture is problematic
        if (vulnerabilities.length > 0) {
            const maxCount = Math.max(criticalCount, highCount, mediumCount, lowCount);
            const barWidth = contentWidth - 50;
            const barHeight = 8;
            const spacing = 15;
            
            const severityData = [
                { label: 'CRITICAL', count: criticalCount, color: [220, 38, 38] },
                { label: 'HIGH', count: highCount, color: [234, 88, 12] },
                { label: 'MEDIUM', count: mediumCount, color: [217, 119, 6] },
                { label: 'LOW', count: lowCount, color: [101, 163, 13] }
            ];
            
            severityData.forEach((item, index) => {
                if (item.count > 0) {
                    const barY = yPosition + (index * spacing);
                    
                    // Severity label
                    doc.setFillColor(...item.color);
                    doc.rect(margin, barY, 8, barHeight, 'F');
                    
                    doc.setTextColor(0, 0, 0);
                    doc.setFont('helvetica', 'bold');
                    safeText(item.label, margin + 12, barY + 6);
                    
                    // Bar background
                    doc.setDrawColor(200, 200, 200);
                    doc.setFillColor(240, 240, 240);
                    doc.rect(margin + 40, barY, barWidth, barHeight, 'F');
                    
                    // Bar fill
                    if (maxCount > 0) {
                        const fillWidth = (item.count / maxCount) * barWidth;
                        doc.setFillColor(...item.color);
                        doc.rect(margin + 40, barY, fillWidth, barHeight, 'F');
                    }
                    
                    // Count label
                    doc.setTextColor(0, 0, 0);
                    safeText(`${item.count} vulnerabilities`, margin + 45 + barWidth, barY + 6, { align: 'right' });
                }
            });
            
            yPosition += (severityData.filter(item => item.count > 0).length * spacing) + 20;
        } else {
            doc.setTextColor(40, 167, 69);
            doc.setFont('helvetica', 'bold');
            safeText(' No vulnerabilities detected - Excellent security posture', margin, yPosition);
            doc.setTextColor(0, 0, 0);
            yPosition += 20;
        }

        // Vulnerability Details Section
        if (vulnerabilities.length > 0) {
            checkNewPage(100);
            yPosition = addSectionTitle('VULNERABILITY DETAILS', yPosition);
            
            vulnerabilities.forEach((vuln, index) => {
                if (checkNewPage(80)) {
                    yPosition = addSectionTitle('VULNERABILITY DETAILS (CONTINUED)', yPosition);
                }
                
                // Severity color box
                const colors = {
                    'critical': [220, 38, 38],
                    'high': [234, 88, 12],
                    'medium': [217, 119, 6],
                    'low': [101, 163, 13]
                };
                
                const color = colors[vuln.severity] || [100, 100, 100];
                doc.setFillColor(...color);
                doc.rect(margin, yPosition - 4, 5, 5, 'F');
                
                // Severity and type
                doc.setTextColor(...color);
                doc.setFont('helvetica', 'bold');
                safeText(`${vuln.severity.toUpperCase()}: ${vuln.type}`, margin + 8, yPosition);
                
                // CVSS score if available
                if (vuln.cvss_score) {
                    doc.setTextColor(100, 100, 100);
                    safeText(`CVSS: ${vuln.cvss_score}`, margin + contentWidth - 20, yPosition, { align: 'right' });
                }
                
                yPosition += 8;
                
                // Description
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(9);
                const descriptionLines = doc.splitTextToSize(safeString(vuln.description), contentWidth);
                doc.text(descriptionLines, margin, yPosition);
                yPosition += (descriptionLines.length * 4) + 4;
                
                // Impact
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(8);
                safeText('Impact:', margin, yPosition);
                doc.setFont('helvetica', 'normal');
                const impactLines = doc.splitTextToSize(safeString(vuln.impact), contentWidth - 10);
                doc.text(impactLines, margin + 15, yPosition);
                yPosition += (impactLines.length * 3.5) + 4;
                
                // Remediation
                doc.setFont('helvetica', 'bold');
                safeText('Remediation:', margin, yPosition);
                doc.setFont('helvetica', 'normal');
                const remediationLines = doc.splitTextToSize(safeString(vuln.remediation), contentWidth - 15);
                doc.text(remediationLines, margin + 25, yPosition);
                yPosition += (remediationLines.length * 3.5) + 4;
                
                // Location
                safeText(`Location: ${safeString(vuln.location || 'Various')}`, margin, yPosition);
                yPosition += 5;
                
                // Evidence if available
                if (vuln.evidence) {
                    doc.setFont('helvetica', 'bold');
                    safeText('Evidence:', margin, yPosition);
                    doc.setFont('helvetica', 'normal');
                    const evidenceLines = doc.splitTextToSize(safeString(vuln.evidence), contentWidth - 10);
                    doc.text(evidenceLines, margin + 18, yPosition);
                    yPosition += (evidenceLines.length * 3.5) + 4;
                }
                
                // Separator line
                if (index < vulnerabilities.length - 1) {
                    doc.setDrawColor(200, 200, 200);
                    doc.line(margin, yPosition, margin + contentWidth, yPosition);
                    yPosition += 12;
                } else {
                    yPosition += 8;
                }
                
                doc.setFontSize(10);
            });
        }

        // Security Recommendations Section
        checkNewPage(100);
        yPosition = addSectionTitle('SECURITY RECOMMENDATIONS', yPosition);
        
        const recommendations = [
            ' Implement all missing security headers (CSP, HSTS, X-Frame-Options, etc.)',
            ' Ensure regular software updates and security patching',
            ' Conduct periodic security scans and penetration testing',
            ' Implement proper input validation and output encoding',
            ' Use HTTPS exclusively for all resources and APIs',
            ' Implement Content Security Policy (CSP) to prevent XSS',
            ' Set Secure, HttpOnly, and SameSite flags on all cookies',
            ' Implement CSRF protection for state-changing operations',
            ' Conduct regular security training for development teams',
            ' Implement proper access controls and authentication mechanisms',
            ' Keep all dependencies and frameworks updated regularly',
            ' Implement proper error handling without information disclosure',
            ' Maintain comprehensive security documentation',
            ' Implement security monitoring and alerting systems'
        ];
        
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        
        recommendations.forEach(rec => {
            if (checkNewPage(20)) yPosition = margin + 15;
            
            const lines = doc.splitTextToSize(rec, contentWidth - 10);
            doc.text(lines, margin + 5, yPosition);
            yPosition += (lines.length * 4) + 3;
        });

        // Footer on all pages
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            
            // Footer background
            doc.setFillColor(59, 130, 246);
            doc.rect(0, pageHeight - 20, pageWidth, 20, 'F');
            
            // Footer text
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            safeText(`Page ${i} of ${pageCount}`, pageWidth / 2, pageHeight - 12, { align: 'center' });
            safeText(`Generated: ${new Date().toLocaleString()} | Security Scanner v1.0`, pageWidth / 2, pageHeight - 6, { align: 'center' });
        }
        
        // Save PDF
        const url = websiteInfo.url || scanData.url || 'report';
        const filename = `security-scan-${url.replace(/[^a-zA-Z0-9]/g, '-')}-${Date.now()}.pdf`;
        doc.save(filename);
        
        // Reset button if it exists
        if (btn) {
            const originalText = '<i class="fas fa-file-pdf"></i> Download PDF Report';
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
        
    } catch (error) {
        console.error('PDF generation failed:', error);
        
        // Show error notification
        showNotification('PDF generation failed: ' + error.message, 'error');
        
        // Reset button if it exists
        if (btn) {
            btn.innerHTML = '<i class="fas fa-file-pdf"></i> Download PDF Report';
            btn.disabled = false;
        }
    }
}

// Excel Report Generation
async function downloadExcelReport(event, scanData) {
    // If scanData is not passed, try to get it from the event target
    if (!scanData && event && event.currentTarget) {
        const dataAttr = event.currentTarget.getAttribute('data-scan-data');
        if (dataAttr) {
            scanData = JSON.parse(dataAttr.replace(/&quot;/g, '"'));
        }
    }
    
    try {
        if (!scanData) {
            throw new Error('No scan data available. Please run a scan first.');
        }

        const btn = event.currentTarget;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating Excel...';
        btn.disabled = true;

        // Use the passed data parameter
        const vulnerabilities = scanData.vulnerabilities || [];
        const scanMetrics = scanData.scan_metrics || {};
        const websiteInfo = scanData.website_info || {};
        const testResults = scanData.detailed_test_results || [];
        const scanType = scanData.scan_type || 'Quick Scan';

        console.log('Excel Data Received:', scanData);

        // Create workbook
        const wb = XLSX.utils.book_new();
        wb.Props = {
            Title: "Security Scan Report",
            Subject: "Vulnerability Assessment",
            Author: "Security Scanner",
            CreatedDate: new Date()
        };
        
        // Summary Sheet
        const criticalCount = vulnerabilities.filter(v => v.severity === 'critical').length;
        const highCount = vulnerabilities.filter(v => v.severity === 'high').length;
        const mediumCount = vulnerabilities.filter(v => v.severity === 'medium').length;
        const lowCount = vulnerabilities.filter(v => v.severity === 'low').length;
        
        const summaryData = [
            ['SECURITY SCAN REPORT - EXECUTIVE SUMMARY'],
            [],
            ['Scan Information', ''],
            ['Target URL', websiteInfo.url || 'N/A'],
            ['Scan Date', scanMetrics.scan_timestamp || new Date().toLocaleDateString()],
            ['Scan Type', scanType],
            ['Total Tests', scanMetrics.total_tests || testResults.length || 0],
            ['Tests Passed', scanMetrics.tests_passed || testResults.filter(t => t.status === 'success').length || 0],
            ['Tests Failed', scanMetrics.tests_failed || testResults.filter(t => ['critical', 'high', 'medium', 'low', 'error'].includes(t.status)).length || 0],
            ['Success Rate', `${scanMetrics.success_rate || 0}%`],
            ['Scan Duration', scanMetrics.scan_duration || 'N/A'],
            [],
            ['Vulnerability Summary', ''],
            ['Critical', criticalCount],
            ['High', highCount],
            ['Medium', mediumCount],
            ['Low', lowCount],
            ['Total Vulnerabilities', vulnerabilities.length],
            [],
            ['Test Results Summary', ''],
            ['Total Tests Executed', testResults.length],
            ['Tests Passed', testResults.filter(t => t.status === 'success').length],
            ['Security Issues Found', testResults.filter(t => ['critical', 'high', 'medium', 'low', 'error'].includes(t.status)).length],
            ['Informational Tests', testResults.filter(t => t.status === 'info').length],
            [],
            ['Risk Assessment', ''],
            ['Overall Risk Level', vulnerabilities.length === 0 ? 'LOW' : 
             criticalCount > 0 ? 'CRITICAL' :
             highCount > 0 ? 'HIGH' : 
             mediumCount > 0 ? 'MEDIUM' : 'LOW']
        ];
        
        const ws_summary = XLSX.utils.aoa_to_sheet(summaryData);
        
        // Vulnerability Details Sheet
        const vulnHeaders = ['Severity', 'Type', 'Description', 'Impact', 'Remediation', 'CVSS Score', 'Location', 'Evidence', 'Category'];
        const vulnData = vulnerabilities.map(v => [
            v.severity.toUpperCase(),
            v.type,
            v.description,
            v.impact,
            v.remediation,
            v.cvss_score || 'N/A',
            v.location || 'Various',
            v.evidence || 'N/A',
            v.category || 'general'
        ]);
        
        // Add "No vulnerabilities" message if empty
        if (vulnData.length === 0) {
            vulnData.push(['N/A', 'No vulnerabilities detected', 'Scan completed successfully', 'No impact', 'Maintain current security practices', 'N/A', 'N/A', 'N/A', 'N/A']);
        }
        
        const ws_vuln = XLSX.utils.aoa_to_sheet([vulnHeaders, ...vulnData]);
        
        // Test Results Sheet
        const testHeaders = ['Test ID', 'Test Name', 'Status', 'Details', 'Timestamp'];
        const testData = testResults.map(t => [
            t.id,
            t.name,
            t.status.toUpperCase(),
            t.details,
            t.timestamp
        ]);
        
        // Add "No tests" message if empty
        if (testData.length === 0) {
            testData.push(['N/A', 'No test results available', 'N/A', 'No tests executed', 'N/A']);
        }
        
        const ws_tests = XLSX.utils.aoa_to_sheet([testHeaders, ...testData]);
        
        // Website Information Sheet
        const websiteHeaders = ['Category', 'Key', 'Value'];
        const websiteData = [];
        
        if (websiteInfo.headers) {
            Object.entries(websiteInfo.headers).forEach(([key, value]) => {
                websiteData.push(['Headers', key, value]);
            });
        }
        
        if (websiteInfo.technologies && websiteInfo.technologies.length > 0) {
            websiteInfo.technologies.forEach(tech => {
                websiteData.push(['Technologies', 'Detected', tech]);
            });
        }
        
        if (websiteInfo.server_info) {
            Object.entries(websiteInfo.server_info).forEach(([key, value]) => {
                websiteData.push(['Server Info', key, value]);
            });
        }
        
        if (websiteData.length === 0) {
            websiteData.push(['Information', 'No website data collected', 'N/A']);
        }
        
        const ws_website = XLSX.utils.aoa_to_sheet([websiteHeaders, ...websiteData]);
        
        // Add sheets to workbook
        XLSX.utils.book_append_sheet(wb, ws_summary, "Executive Summary");
        XLSX.utils.book_append_sheet(wb, ws_vuln, "Vulnerabilities");
        XLSX.utils.book_append_sheet(wb, ws_tests, "Test Results");
        XLSX.utils.book_append_sheet(wb, ws_website, "Website Info");
        
        // Generate and download
        const url = websiteInfo.url || scanData.url || 'report';
        const filename = `security-scan-${url.replace(/[^a-zA-Z0-9]/g, '-')}-${Date.now()}.xlsx`;
        XLSX.writeFile(wb, filename);
        
        btn.innerHTML = originalText;
        btn.disabled = false;
        
    } catch (error) {
        console.error('Excel generation failed:', error);
        alert('Excel generation failed: ' + error.message);
        if (event && event.currentTarget) {
            event.currentTarget.innerHTML = '<i class="fas fa-file-excel"></i> Download Excel Report';
            event.currentTarget.disabled = false;
        }
    }
}

// Executive Summary (Simplified PDF)
async function downloadExecutiveSummary(event, scanData) {
    // If scanData is not passed, try to get it from the event target
    if (!scanData && event && event.currentTarget) {
        const dataAttr = event.currentTarget.getAttribute('data-scan-data');
        if (dataAttr) {
            scanData = JSON.parse(dataAttr.replace(/&quot;/g, '"'));
        }
    }
    
    try {
        if (!scanData) {
            throw new Error('No scan data available. Please run a scan first.');
        }

        const btn = event.currentTarget;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating Summary...';
        btn.disabled = true;

        // Use the passed data parameter
        const vulnerabilities = scanData.vulnerabilities || [];
        const scanMetrics = scanData.scan_metrics || {};
        const websiteInfo = scanData.website_info || {};
        const testResults = scanData.detailed_test_results || [];
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Styling
        doc.setFillColor(59, 130, 246);
        doc.rect(0, 0, doc.internal.pageSize.width, 30, 'F');
        
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.text('SECURITY SCAN EXECUTIVE SUMMARY', 105, 20, { align: 'center' });
        
        let yPosition = 50;
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(10);
        
        // Quick Overview
        const criticalCount = vulnerabilities.filter(v => v.severity === 'critical').length;
        const highCount = vulnerabilities.filter(v => v.severity === 'high').length;
        const totalTests = testResults.length;
        const passedTests = testResults.filter(t => t.status === 'success').length;

        doc.setFont('helvetica', 'bold');
        doc.text('QUICK OVERVIEW', 20, yPosition);
        yPosition += 10;
        
        doc.setFont('helvetica', 'normal');
        doc.text(`Scanned URL: ${websiteInfo.url || 'N/A'}`, 20, yPosition);
        yPosition += 6;
        doc.text(`Scan Date: ${scanMetrics.scan_timestamp || new Date().toLocaleDateString()}`, 20, yPosition);
        yPosition += 6;
        doc.text(`Total Tests: ${totalTests}`, 20, yPosition);
        yPosition += 6;
        doc.text(`Tests Passed: ${passedTests}`, 20, yPosition);
        yPosition += 6;
        doc.text(`Total Vulnerabilities: ${vulnerabilities.length}`, 20, yPosition);
        yPosition += 6;
        doc.text(`Critical Issues: ${criticalCount}`, 20, yPosition);
        yPosition += 6;
        doc.text(`High Severity: ${highCount}`, 20, yPosition);
        yPosition += 15;
        
        // Priority Actions
        doc.setFont('helvetica', 'bold');
        doc.text('PRIORITY ACTIONS', 20, yPosition);
        yPosition += 10;
        
        if (criticalCount > 0) {
            doc.setTextColor(220, 38, 38);
            doc.text(' IMMEDIATE ACTION REQUIRED:', 20, yPosition);
            yPosition += 6;
            doc.text(`Address ${criticalCount} critical vulnerabilities immediately`, 25, yPosition);
            yPosition += 10;
        }
        
        if (highCount > 0) {
            doc.setTextColor(234, 88, 12);
            doc.text(' URGENT ATTENTION NEEDED:', 20, yPosition);
            yPosition += 6;
            doc.text(`Fix ${highCount} high-severity vulnerabilities within 7 days`, 25, yPosition);
            yPosition += 10;
        }
        
        if (vulnerabilities.length === 0) {
            doc.setTextColor(40, 167, 69);
            doc.text(' EXCELLENT: No security vulnerabilities detected', 20, yPosition);
            yPosition += 10;
        } else if (criticalCount === 0 && highCount === 0) {
            doc.setTextColor(101, 163, 13);
            doc.text(' GOOD: No critical or high-severity vulnerabilities found', 20, yPosition);
            yPosition += 10;
        }
        
        doc.setTextColor(0, 0, 0);
        yPosition += 5;
        
        // Top Recommendations
        doc.setFont('helvetica', 'bold');
        doc.text('TOP RECOMMENDATIONS', 20, yPosition);
        yPosition += 10;
        
        const topRecs = [
            criticalCount > 0 ? '1. Address critical vulnerabilities immediately' : '1. Maintain current security practices',
            highCount > 0 ? '2. Fix high-severity vulnerabilities within 7 days' : '2. Continue regular security monitoring',
            '3. Implement missing security headers',
            '4. Schedule regular security scans',
            '5. Keep all software components updated'
        ];
        
        topRecs.forEach(rec => {
            doc.setFont('helvetica', 'normal');
            doc.text(rec, 20, yPosition);
            yPosition += 6;
        });
        
        // Footer
        doc.setFontSize(8);
        doc.setTextColor(100, 100, 100);
        doc.text(`Generated: ${new Date().toLocaleString()}`, 105, doc.internal.pageSize.height - 10, { align: 'center' });
        
        const url = websiteInfo.url || scanData.url || 'report';
        const filename = `security-summary-${url.replace(/[^a-zA-Z0-9]/g, '-')}-${Date.now()}.pdf`;
        doc.save(filename);
        
        btn.innerHTML = originalText;
        btn.disabled = false;
        
    } catch (error) {
        console.error('Summary generation failed:', error);
        alert('Summary generation failed: ' + error.message);
        if (event && event.currentTarget) {
            event.currentTarget.innerHTML = '<i class="fas fa-file-alt"></i> Executive Summary';
            event.currentTarget.disabled = false;
        }
    }
}

async function captureChartAsImage(chartId) {
    return new Promise((resolve, reject) => {
        try {
            const chart = window.vulnChart;
            if (!chart) {
                console.warn('No chart found to capture');
                resolve(null);
                return;
            }

            // Get the chart canvas
            const canvas = document.getElementById('vuln-chart');
            if (!canvas) {
                console.warn('Chart canvas not found');
                resolve(null);
                return;
            }

            // Convert canvas to data URL
            const dataURL = canvas.toDataURL('image/png', 1.0);
            resolve(dataURL);
        } catch (error) {
            console.error('Error capturing chart:', error);
            reject(error);
        }
    });
}

async function captureMetricsAsImage() {
    return new Promise((resolve, reject) => {
        try {
            // Find the metrics section
            const metricsSection = document.querySelector('.metrics-grid');
            const summaryCards = document.querySelector('.summary-cards-div');
            
            if (!metricsSection && !summaryCards) {
                resolve(null);
                return;
            }

            // Use html2canvas to capture the elements
            if (typeof html2canvas === 'undefined') {
                console.warn('html2canvas not loaded');
                resolve(null);
                return;
            }

            // Capture metrics grid
            const capturePromises = [];
            if (metricsSection) {
                capturePromises.push(html2canvas(metricsSection, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    useCORS: true,
                    allowTaint: true
                }));
            }

            if (summaryCards) {
                capturePromises.push(html2canvas(summaryCards, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    useCORS: true,
                    allowTaint: true
                }));
            }

            Promise.all(capturePromises).then(canvases => {
                const images = canvases.map(canvas => canvas.toDataURL('image/png', 1.0));
                resolve(images);
            }).catch(error => {
                console.error('Error capturing metrics:', error);
                resolve(null);
            });

        } catch (error) {
            console.error('Error in captureMetricsAsImage:', error);
            resolve(null);
        }
    });
}

function displayProfessionalVulnerabilityResults(results) {
    console.log('Professional results:', results);

    try {
        // Safely extract the actual data with proper error handling
        let data;

        // Handle the nested structure from the PHP response
        if (results && results.data && results.data.data) {
            // Nested structure: results.data.data
            data = results.data.data;
        } else if (results && results.data) {
            // Direct structure: results.data  
            data = results.data;
        } else if (results) {
            // Root level structure
            data = results;
        } else {
            console.error('Unexpected data structure:', results);
            alert('Error: Unexpected response format from server');
            return;
        }

        console.log('Processed data for display:', data);

        // Check if we have professional format data
        if (data.categorized_findings && data.executive_summary) {
            // Store data in a global variable for debugging
            window.lastScanData = data;
            
            // Create the main results container
            const resultsContainer = document.getElementById('vuln-results');
            resultsContainer.innerHTML = '';
            
            // Build the professional interface with error handling
            try {
                resultsContainer.appendChild(createProfessionalHeader(data));
                resultsContainer.appendChild(createRiskAssessmentBanner(data.risk_assessment));
                resultsContainer.appendChild(createExecutiveSummary(data.executive_summary));
                resultsContainer.appendChild(createScanMetrics(data.scan_metrics));
                
                const vulnerabilities = Array.isArray(data.vulnerabilities) ? data.vulnerabilities : [];
                const summary = data.summary || calculateVulnerabilitySummary(vulnerabilities);
                
                if (vulnerabilities.length > 0 || (summary.critical + summary.high + summary.medium + summary.low) > 0) {
                    resultsContainer.appendChild(createVulnerabilityOverview(vulnerabilities, summary));
                    resultsContainer.appendChild(createCategorizedFindings(data.categorized_findings));
                    resultsContainer.appendChild(createDetailedVulnerabilitySection(vulnerabilities));
                } else {
                    resultsContainer.appendChild(createNoVulnerabilitiesSection());
                }
                
                if (data.recommendations && data.recommendations.length > 0) {
                    resultsContainer.appendChild(createProfessionalRecommendations(data.recommendations));
                }
                
                resultsContainer.appendChild(createTechnologyStack(data.website_info));
                resultsContainer.appendChild(createScanDetails(data));
                
                // Add download buttons
                addDownloadButtons(resultsContainer, data);
                
            } catch (buildError) {
                console.error('Error building professional interface:', buildError);
                resultsContainer.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error Displaying Results</h3>
                        <p>${buildError.message}</p>
                        <button onclick="displayBasicVulnerabilityResults(window.lastScanData)">
                            Show Basic Results Instead
                        </button>
                    </div>
                `;
            }
        } else if (data.vulnerabilities !== undefined || data.scan_metrics) {
            // Use basic display for other formats
            displayBasicVulnerabilityResults(data);
        } else {
            // Fallback for any other structure
            console.warn('Using fallback display for data structure');
            displayBasicVulnerabilityResults(data);
        }
    } catch (error) {
        console.error('Fatal error in displayProfessionalVulnerabilityResults:', error);
        document.getElementById('vuln-results').innerHTML = `
            <div class="error-message">
                <i class="fas fa-bug"></i>
                <h3>Critical Error</h3>
                <p>${error.message}</p>
                <pre>${error.stack}</pre>
            </div>
        `;
    }
}

function createNoVulnerabilitiesSection() {
    const section = document.createElement('div');
    section.className = 'no-vulnerabilities-section';
    section.innerHTML = `
        <div class="section-header">
            <h2><i class="fas fa-check-circle"></i> No Vulnerabilities Found</h2>
        </div>
        <div class="success-message">
            <div class="success-icon">
                <i class="fas fa-shield-check"></i>
            </div>
            <div class="success-content">
                <h3>Excellent Security Posture</h3>
                <p>The comprehensive security scan completed successfully and no vulnerabilities were detected.</p>
                <div class="success-tips">
                    <strong>Recommended Actions:</strong>
                    <ul>
                        <li>Continue regular security monitoring</li>
                        <li>Schedule periodic security scans</li>
                        <li>Maintain current security practices</li>
                        <li>Keep all software components updated</li>
                    </ul>
                </div>
            </div>
        </div>
    `;
    return section;
}

function createScanMetrics(scanMetrics) {
    // Handle undefined or null scanMetrics
    const metrics = scanMetrics || {};
    const totalTests = metrics.total_tests || 0;
    const testsPassed = metrics.tests_passed || 0;
    const testsFailed = metrics.tests_failed || 0;
    const successRate = totalTests > 0 ? Math.round((testsPassed / totalTests) * 100) : 0;
    
    const section = document.createElement('div');
    section.className = 'scan-metrics-section';
    
    section.innerHTML = `
        <div class="section-header">
            <h2><i class="fas fa-chart-bar"></i> Scan Metrics & Performance</h2>
        </div>
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-icon">
                    <i class="fas fa-vial"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-value">${totalTests}</div>
                    <div class="metric-label">Total Security Tests</div>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-icon" style="color: #28a745;">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-value" style="color: #28a745;">${testsPassed}</div>
                    <div class="metric-label">Tests Passed</div>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-icon" style="color: #dc3545;">
                    <i class="fas fa-exclamation-circle"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-value" style="color: #dc3545;">${testsFailed}</div>
                    <div class="metric-label">Security Issues Found</div>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-icon" style="color: #17a2b8;">
                    <i class="fas fa-info-circle"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-value" style="color: #17a2b8;">${successRate}%</div>
                    <div class="metric-label">Success Rate</div>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-icon" style="color: #6f42c1;">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-value" style="color: #6f42c1;">${metrics.scan_duration || 'Unknown'}</div>
                    <div class="metric-label">Scan Duration</div>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-icon" style="color: #fd7e14;">
                    <i class="fas fa-bug"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-value" style="color: #fd7e14;">${metrics.vulnerabilities_found || 0}</div>
                    <div class="metric-label">Vulnerabilities Found</div>
                </div>
            </div>
        </div>
        
        ${metrics.scan_intensity ? `
        <div class="scan-intensity">
            <div class="intensity-label">Scan Intensity:</div>
            <div class="intensity-value">${metrics.scan_intensity}</div>
        </div>
        ` : ''}
        
        ${metrics.scan_coverage ? `
        <div class="scan-coverage">
            <div class="coverage-label">Test Coverage:</div>
            <div class="coverage-value">${metrics.scan_coverage}</div>
        </div>
        ` : ''}
    `;
    
    return section;
}

function createProfessionalHeader(data) {
    // Safely access website_info with fallbacks
    const websiteInfo = data.website_info || data.data?.website_info || {};
    const url = websiteInfo.url || 'Unknown URL';
    const scanType = data.scan_type || data.data?.scan_type || 'quick';
    
    const header = document.createElement('div');
    header.className = 'professional-scan-header';
    header.innerHTML = `
        <div class="scan-header-content">
            <div class="header-branding">
                <i class="fas fa-shield-alt"></i>
                <div class="header-text">
                    <h1>Professional Security Assessment Report</h1>
                    <p class="scan-subtitle">Comprehensive Vulnerability Analysis</p>
                </div>
            </div>
            <div class="header-meta">
                <div class="meta-grid">
                    <div class="meta-item">
                        <strong>Target:</strong>
                        <span class="target-url">${url}</span>
                    </div>
                    <div class="meta-item">
                        <strong>Scan Type:</strong>
                        <span class="scan-type-badge">${scanType.toUpperCase()}</span>
                    </div>
                    <div class="meta-item">
                        <strong>Date:</strong>
                        <span>${new Date().toLocaleDateString()}</span>
                    </div>
                    <div class="meta-item">
                        <strong>Duration:</strong>
                        <span>${data.scan_metrics?.scan_duration || data.data?.scan_metrics?.scan_duration || 'Unknown'}</span>
                    </div>
                </div>
            </div>
        </div>
    `;
    return header;
}

function createRiskAssessmentBanner(riskAssessment) {
    // Handle undefined or null riskAssessment
    const assessment = riskAssessment || {
        level: 'UNKNOWN',
        description: 'Risk assessment not available',
        color: '#6b7280'
    };
    
    const banner = document.createElement('div');
    banner.className = `risk-assessment-banner risk-${assessment.level.toLowerCase()}`;
    banner.innerHTML = `
        <div class="risk-banner-content">
            <div class="risk-indicator">
                <i class="fas fa-${getRiskIcon(assessment.level)}"></i>
                <div class="risk-text">
                    <div class="risk-level">${assessment.level} RISK</div>
                    <div class="risk-description">${assessment.description}</div>
                </div>
            </div>
            <div class="risk-actions">
                <button class="btn-risk-details" onclick="showRiskDetails()">
                    <i class="fas fa-chart-bar"></i>
                    View Detailed Analysis
                </button>
            </div>
        </div>
    `;
    return banner;
}

function createExecutiveSummary(executiveSummary) {
    // Handle undefined or null executiveSummary
    const summary = executiveSummary || {
        overall_risk: 'UNKNOWN',
        summary: 'Executive summary not available',
        priority: 'UNKNOWN'
    };
    
    const section = document.createElement('div');
    section.className = 'executive-summary-section';
    section.innerHTML = `
        <div class="section-header">
            <h2><i class="fas fa-chart-line"></i> Executive Summary</h2>
        </div>
        <div class="executive-content">
            <div class="summary-alert alert-${summary.overall_risk.toLowerCase()}">
                <div class="alert-icon">
                    <i class="fas fa-${getPriorityIcon(summary.priority)}"></i>
                </div>
                <div class="alert-content">
                    <h3>${summary.overall_risk} Security Posture</h3>
                    <p>${summary.summary}</p>
                    <div class="priority-badge priority-${summary.priority.toLowerCase()}">
                        ${summary.priority.replace(/_/g, ' ')}
                    </div>
                </div>
            </div>
        </div>
    `;
    return section;
}

function createVulnerabilityOverview(vulnerabilities, summary) {
    // Use provided summary or calculate from vulnerabilities
    let vulnSummary;
    if (summary && (summary.critical !== undefined || summary.high !== undefined)) {
        vulnSummary = summary;
    } else {
        vulnSummary = calculateVulnerabilitySummary(vulnerabilities);
    }
    
    const section = document.createElement('div');
    section.className = 'vulnerability-overview-section';
    section.innerHTML = `
        <div class="section-header">
            <h2><i class="fas fa-bug"></i> Vulnerability Overview</h2>
            <span class="vuln-count">${vulnerabilities.length} Total Issues</span>
        </div>
        <div class="overview-grid">
            <div class="overview-card critical">
                <div class="overview-icon">
                    <i class="fas fa-skull-crossbones"></i>
                </div>
                <div class="overview-content">
                    <div class="overview-count">${vulnSummary.critical || 0}</div>
                    <div class="overview-label">Critical</div>
                </div>
            </div>
            <div class="overview-card high">
                <div class="overview-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="overview-content">
                    <div class="overview-count">${vulnSummary.high || 0}</div>
                    <div class="overview-label">High</div>
                </div>
            </div>
            <div class="overview-card medium">
                <div class="overview-icon">
                    <i class="fas fa-exclamation-circle"></i>
                </div>
                <div class="overview-content">
                    <div class="overview-count">${vulnSummary.medium || 0}</div>
                    <div class="overview-label">Medium</div>
                </div>
            </div>
            <div class="overview-card low">
                <div class="overview-icon">
                    <i class="fas fa-info-circle"></i>
                </div>
                <div class="overview-content">
                    <div class="overview-count">${vulnSummary.low || 0}</div>
                    <div class="overview-label">Low</div>
                </div>
            </div>
        </div>
    `;
    return section;
}

function calculateVulnerabilitySummary(vulnerabilities) {
    const summary = {
        critical: 0,
        high: 0,
        medium: 0,
        low: 0
    };
    
    vulnerabilities.forEach(vuln => {
        const severity = (vuln.severity || 'low').toLowerCase();
        if (summary[severity] !== undefined) {
            summary[severity]++;
        } else {
            summary.low++; // Default to low if unknown severity
        }
    });
    
    return summary;
}

function createCategorizedFindings(categorizedFindings) {
    const section = document.createElement('div');
    section.className = 'categorized-findings-section';
    
    let categoriesHtml = '';
    Object.entries(categorizedFindings).forEach(([category, findings]) => {
        if (findings.length > 0) {
            categoriesHtml += `
                <div class="category-card">
                    <div class="category-header">
                        <h4>${formatCategoryName(category)}</h4>
                        <span class="category-count">${findings.length}</span>
                    </div>
                    <div class="category-severity">
                        ${getCategorySeverityBreakdown(findings)}
                    </div>
                </div>
            `;
        }
    });
    
    section.innerHTML = `
        <div class="section-header">
            <h2><i class="fas fa-layer-group"></i> Findings by Category</h2>
        </div>
        <div class="categories-grid">
            ${categoriesHtml}
        </div>
    `;
    
    return section;
}

function createDetailedVulnerabilitySection(vulnerabilities) {
    const section = document.createElement('div');
    section.className = 'detailed-vulnerability-section';
    
    // Group by severity
    const groupedVulns = groupVulnerabilitiesBySeverity(vulnerabilities);
    
    let vulnerabilitiesHtml = '';
    const severityOrder = ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW'];
    
    severityOrder.forEach(severity => {
        if (groupedVulns[severity] && groupedVulns[severity].length > 0) {
            vulnerabilitiesHtml += createSeverityVulnerabilityGroup(severity, groupedVulns[severity]);
        }
    });
    
    section.innerHTML = `
        <div class="section-header">
            <h2><i class="fas fa-search"></i> Detailed Vulnerability Analysis</h2>
        </div>
        ${vulnerabilitiesHtml}
    `;
    
    return section;
}

function groupVulnerabilitiesBySeverity(vulnerabilities) {
    const grouped = {
        'CRITICAL': [],
        'HIGH': [],
        'MEDIUM': [],
        'LOW': []
    };
    
    // Check if vulnerabilities is an array
    if (!Array.isArray(vulnerabilities)) {
        console.warn('groupVulnerabilitiesBySeverity: vulnerabilities is not an array');
        return grouped;
    }
    
    vulnerabilities.forEach(vuln => {
        if (!vuln || typeof vuln !== 'object') {
            console.warn('Invalid vulnerability object:', vuln);
            return;
        }
        
        const severity = vuln.severity ? vuln.severity.toUpperCase() : 'LOW';
        
        // Map to valid severity levels
        if (grouped[severity]) {
            grouped[severity].push(vuln);
        } else if (severity.includes('CRIT')) {
            grouped['CRITICAL'].push(vuln);
        } else if (severity.includes('HIGH')) {
            grouped['HIGH'].push(vuln);
        } else if (severity.includes('MEDIUM') || severity.includes('MED')) {
            grouped['MEDIUM'].push(vuln);
        } else {
            grouped['LOW'].push(vuln); // Default to LOW if unknown severity
        }
    });
    
    return grouped;
}

function createSeverityVulnerabilityGroup(severity, vulnerabilities) {
    // Make sure vulnerabilities is an array
    if (!Array.isArray(vulnerabilities) || vulnerabilities.length === 0) {
        return '';
    }
    
    return `
        <div class="severity-vulnerability-group severity-${severity.toLowerCase()}">
            <div class="severity-group-header">
                <h3>
                    <i class="fas fa-${getSeverityIcon(severity)}"></i>
                    ${severity} Severity Vulnerabilities
                    <span class="severity-count">${vulnerabilities.length} issues</span>
                </h3>
            </div>
            <div class="vulnerability-cards">
                ${vulnerabilities.map(vuln => {
                    // Pass each vulnerability object to the function
                    return createProfessionalVulnerabilityCard(vuln);
                }).join('')}
            </div>
        </div>
    `;
}

function getSeverityIcon(severity) {
    const icons = {
        'CRITICAL': 'skull-crossbones',
        'HIGH': 'exclamation-triangle',
        'MEDIUM': 'exclamation-circle',
        'LOW': 'info-circle'
    };
    return icons[severity] || 'question-circle';
}

// Stub functions for buttons (implement as needed)
function showRiskDetails() {
    console.log('Show risk details clicked');
    // Implement detailed risk analysis view
}

function openCVE(cveId) {
    console.log('Open CVE:', cveId);
    // Open CVE details in new tab
    window.open(`https://nvd.nist.gov/vuln/detail/${cveId}`, '_blank');
}

function showRemediationDetails(vulnId) {
    console.log('Show remediation for:', vulnId);
    // Implement detailed remediation view
}

function createProfessionalVulnerabilityCard(vulnerability) {
    if (!vulnerability) {
        console.error('Vulnerability is undefined');
        return '<div class="professional-vulnerability-card unknown">Error: No vulnerability data</div>';
    }
    
    // Safely get all properties
    const type = vulnerability.type || 'Unknown Vulnerability';
    const severity = vulnerability.severity ? vulnerability.severity.toUpperCase() : 'UNKNOWN';
    const severityLower = severity.toLowerCase();
    const location = vulnerability.location || 'Various';
    
    // Handle CVSS score
    const cvssScore = parseFloat(vulnerability.cvss_score) || 0;
    const cvssDisplay = cvssScore > 0 ? cvssScore.toFixed(1) : 'N/A';
    const cvssColor = getCVSSColor(cvssScore);
    const cvssRating = getCVSSRating(cvssScore);
    
    const description = vulnerability.description || 'No description available';
    const impact = vulnerability.impact || 'No impact information available';
    const evidence = vulnerability.evidence || 'No evidence provided';
    const remediation = vulnerability.remediation || 'No remediation provided';
    const cves = Array.isArray(vulnerability.cves) ? vulnerability.cves : [];
    
    // Create a clean vulnerability object for the data attribute
    const cleanVulnerability = {
        type: type,
        severity: severity,
        description: description,
        impact: impact,
        remediation: remediation,
        location: location,
        cvss_score: cvssScore,
        evidence: evidence
    };
    
    // Add CVEs if present
    if (cves.length > 0) {
        cleanVulnerability.cves = cves.slice(0, 5); // Limit to 5 CVEs
    }

    return `
        <div class="professional-vulnerability-card ${severityLower}">
            <div class="vuln-card-header">
                <div class="vuln-main-info">
                    <h4 class="vuln-title">${type}</h4>
                    <div class="vuln-meta">
                        <span class="vuln-location">${location}</span>
                        <span class="vuln-cvss" 
                              style="background: ${cvssColor}"
                              onmouseenter="showCVSSDetails(${cvssScore}, this)"
                              onclick="window.open('https://www.first.org/cvss/calculator/3.1#${cvssScore.toFixed(1)}', '_blank')"
                              title="CVSS ${cvssDisplay} - ${cvssRating}">
                            CVSS: ${cvssDisplay}
                        </span>
                        ${cves.length > 0 ? 
                            `<span class="vuln-cves">${cves.length} CVEs</span>` : ''
                        }
                    </div>
                </div>
                <div class="vuln-severity-badge severity-${severityLower}">
                    ${severity}
                </div>
            </div>
            
            <div class="vuln-card-content">
                <div class="vuln-description">
                    <strong>Description:</strong>
                    <p>${description}</p>
                </div>
                
                <div class="vuln-impact">
                    <strong>Impact:</strong>
                    <p>${impact}</p>
                </div>
                
                <div class="vuln-evidence">
                    <strong>Evidence:</strong>
                    <div class="evidence-content">
                        <code>${escapeHtmlProfVul(evidence)}</code>
                    </div>
                </div>
                
                ${cves.length > 0 ? `
                <div class="vuln-cve-list">
                    <strong>Associated CVEs:</strong>
                    <div class="cve-tags">
                        ${cves.slice(0, 3).map(cve => `
                            <span class="cve-tag" onclick="window.open('https://nvd.nist.gov/vuln/detail/${cve}', '_blank')">
                                <i class="fas fa-external-link-alt"></i>
                                ${cve}
                            </span>
                        `).join('')}
                        ${cves.length > 3 ? `
                            <span class="cve-more">+${cves.length - 3} more</span>
                        ` : ''}
                    </div>
                </div>
                ` : ''}
            </div>
            
            <div class="vuln-card-footer">
                <div class="remediation-section">
                    <strong>Remediation:</strong>
                    <p>${remediation}</p>
                </div>
                <div class="vuln-actions">
                    <button class="btn-remediation" 
                            data-vulnerability='${JSON.stringify(cleanVulnerability).replace(/'/g, "&apos;")}'
                            onclick="openAIFixModalFromButton(this)">
                        <i class="fas fa-robot"></i>
                        AI-Powered Detailed Fix
                    </button>
                </div>
            </div>
        </div>
    `;
}

function escapeHtmlProfVul(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getCVSSColor(score) {
    if (score >= 9.0) return '#dc2626'; // Critical - Red
    if (score >= 7.0) return '#ea580c'; // High - Orange
    if (score >= 4.0) return '#d97706'; // Medium - Yellow
    if (score >= 0.1) return '#16a34a'; // Low - Green
    return '#6b7280'; // None - Gray
}

function showCVSSDetails(score, element) {
    const tooltip = document.createElement('div');
    tooltip.className = 'cvss-tooltip';
    tooltip.innerHTML = `
        <strong>CVSS Score: ${score.toFixed(1)}</strong><br>
        ${this.getCVSSRating(score)}<br>
        <small>Click for details</small>
    `;
    tooltip.style.position = 'absolute';
    tooltip.style.background = '#1f2937';
    tooltip.style.color = 'white';
    tooltip.style.padding = '0.5rem';
    tooltip.style.borderRadius = '4px';
    tooltip.style.zIndex = '10000';
    tooltip.style.boxShadow = '0 2px 8px rgba(0,0,0,0.3)';
    
    const rect = element.getBoundingClientRect();
    tooltip.style.top = (rect.top - tooltip.offsetHeight - 10) + 'px';
    tooltip.style.left = (rect.left + rect.width/2 - tooltip.offsetWidth/2) + 'px';
    
    document.body.appendChild(tooltip);
    
    // Remove on mouse leave
    element.addEventListener('mouseleave', () => {
        if (tooltip.parentElement) {
            tooltip.remove();
        }
    }, { once: true });
    
    // Click to open CVSS calculator
    tooltip.addEventListener('click', () => {
        window.open(`https://www.first.org/cvss/calculator/3.1#${score.toFixed(1)}`, '_blank');
        tooltip.remove();
    });
}

function getCVSSRating(score) {
    if (score >= 9.0) return 'Critical';
    if (score >= 7.0) return 'High';
    if (score >= 4.0) return 'Medium';
    if (score >= 0.1) return 'Low';
    return 'None';
}

function openAIFixModalFromButton(buttonElement) {
    try {
        const vulnerabilityJson = buttonElement.getAttribute('data-vulnerability');
        if (!vulnerabilityJson) {
            throw new Error('No vulnerability data found');
        }
        
        // Decode the HTML entity
        const decodedJson = vulnerabilityJson.replace(/&apos;/g, "'");
        const vulnerability = JSON.parse(decodedJson);
        
        // Open the modal
        openAIFixModal(vulnerability);
        
    } catch (error) {
        console.error('Error opening AI fix modal from button:', error);
        showNotification('Error opening AI fix assistant: ' + error.message, 'error');
    }
}

function openAIFixModalFromCard(vulnerabilityJson) {
    try {
        // Decode the HTML entities first
        let decodedJson = vulnerabilityJson
            .replace(/&quot;/g, '"')
            .replace(/&#x27;/g, "'");
        
        // Parse the JSON
        const vulnerability = JSON.parse(decodedJson);
        
        // Now call the actual modal opening function
        if (typeof openAIFixModal === 'function') {
            openAIFixModal(vulnerability);
        } else {
            console.error('openAIFixModal function not found');
            showNotification('AI Fix Assistant is not available', 'error');
        }
        
    } catch (error) {
        console.error('Error parsing vulnerability data:', error);
        showNotification('Error opening AI fix assistant', 'error');
    }
}

function getRiskIcon(riskLevel) {
    const icons = {
        'CRITICAL': 'skull-crossbones',
        'HIGH': 'exclamation-triangle',
        'MEDIUM': 'exclamation-circle',
        'LOW': 'info-circle',
        'UNKNOWN': 'question-circle'
    };
    return icons[riskLevel] || 'question-circle';
}

function getPriorityIcon(priority) {
    const icons = {
        'IMMEDIATE_ACTION_REQUIRED': 'fire',
        'URGENT_ATTENTION_NEEDED': 'clock',
        'SECURITY_ENHANCEMENT': 'shield-alt',
        'UNKNOWN': 'question-circle'
    };
    return icons[priority] || 'question-circle';
}

function formatCategoryName(category) {
    return category.split('_').map(word => 
        word.charAt(0).toUpperCase() + word.slice(1)
    ).join(' ');
}

function getCategorySeverityBreakdown(findings) {
    const severityCounts = {
        critical: 0,
        high: 0,
        medium: 0,
        low: 0
    };
    
    findings.forEach(finding => {
        const severity = finding.severity.toLowerCase();
        if (severityCounts[severity] !== undefined) {
            severityCounts[severity]++;
        }
    });
    
    return Object.entries(severityCounts)
        .filter(([_, count]) => count > 0)
        .map(([severity, count]) => `
            <span class="severity-dot ${severity}">${count}</span>
        `).join('');
}

// Enhanced CSS for professional interface
const professionalCSS = `
.professional-scan-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    border-radius: 12px;
    margin-bottom: 2rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.scan-header-content {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.header-branding {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.header-branding i {
    font-size: 2.5rem;
    opacity: 0.9;
}

.header-text h1 {
    margin: 0;
    font-size: 2rem;
    font-weight: 700;
}

.scan-subtitle {
    margin: 0;
    opacity: 0.9;
    font-size: 1.1rem;
}

.meta-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.meta-item {
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
}

.target-url {
    font-family: monospace;
    background: rgba(255,255,255,0.1);
    padding: 0.3rem 0.6rem;
    border-radius: 4px;
    font-size: 0.9rem;
}

.scan-type-badge {
    background: rgba(255,255,255,0.2);
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
}

.risk-assessment-banner {
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 2rem;
    color: white;
    font-weight: 600;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.risk-assessment-banner.critical {
    background: linear-gradient(135deg, #dc2626, #ef4444);
}

.risk-assessment-banner.high {
    background: linear-gradient(135deg, #ea580c, #f97316);
}

.risk-assessment-banner.medium {
    background: linear-gradient(135deg, #d97706, #f59e0b);
}

.risk-assessment-banner.low {
    background: linear-gradient(135deg, #16a34a, #22c55e);
}

.risk-banner-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.risk-indicator {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.risk-indicator i {
    font-size: 2rem;
}

.risk-level {
    font-size: 1.5rem;
    font-weight: 700;
}

.risk-description {
    opacity: 0.9;
    font-weight: 500;
}

.btn-risk-details {
    background: rgba(255,255,255,0.2);
    border: 1px solid rgba(255,255,255,0.3);
    color: white;
    padding: 0.7rem 1.2rem;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-risk-details:hover {
    background: rgba(255,255,255,0.3);
}

.executive-summary-section {
    margin-bottom: 2rem;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #e5e7eb;
}

.section-header h2 {
    margin: 0;
    color: #1f2937;
    font-size: 1.5rem;
}

.summary-alert {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    padding: 1.5rem;
    border-radius: 8px;
    border-left: 4px solid;
}

.alert-critical { background: #fef2f2; border-left-color: #dc2626; }
.alert-high { background: #fff7ed; border-left-color: #ea580c; }
.alert-medium { background: #fffbeb; border-left-color: #d97706; }
.alert-low { background: #f0fdf4; border-left-color: #16a34a; }

.alert-icon i {
    font-size: 1.5rem;
}

.alert-critical .alert-icon i { color: #dc2626; }
.alert-high .alert-icon i { color: #ea580c; }
.alert-medium .alert-icon i { color: #d97706; }
.alert-low .alert-icon i { color: #16a34a; }

.priority-badge {
    padding: 0.3rem 0.8rem;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
    margin-top: 0.5rem;
}

.priority-immediate_action_required { background: #dc2626; color: white; }
.priority-urgent_attention_needed { background: #ea580c; color: white; }
.priority-security_enhancement { background: #16a34a; color: white; }

.vulnerability-overview-section {
    margin-bottom: 2rem;
}

.overview-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
}

.overview-card {
    padding: 1.5rem;
    border-radius: 8px;
    color: white;
    display: flex;
    align-items: center;
    gap: 1rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.overview-card.critical { background: linear-gradient(135deg, #dc2626, #ef4444); }
.overview-card.high { background: linear-gradient(135deg, #ea580c, #f97316); }
.overview-card.medium { background: linear-gradient(135deg, #d97706, #f59e0b); }
.overview-card.low { background: linear-gradient(135deg, #16a34a, #22c55e); }

.overview-icon i {
    font-size: 2rem;
    opacity: 0.9;
}

.overview-count {
    font-size: 2rem;
    font-weight: 700;
    line-height: 1;
}

.overview-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

.categorized-findings-section {
    margin-bottom: 2rem;
}

.categories-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
}

.category-card {
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 1.5rem;
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.category-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.category-header h4 {
    margin: 0;
    color: #374151;
    font-size: 1.1rem;
}

.category-count {
    background: #3b82f6;
    color: white;
    padding: 0.2rem 0.6rem;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
}

.category-severity {
    display: flex;
    gap: 0.5rem;
}

.severity-dot {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: 600;
    color: white;
}

.severity-dot.critical { background: #dc2626; }
.severity-dot.high { background: #ea580c; }
.severity-dot.medium { background: #d97706; }
.severity-dot.low { background: #16a34a; }

.detailed-vulnerability-section {
    margin-bottom: 2rem;
}

.severity-vulnerability-group {
    margin-bottom: 2rem;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    overflow: hidden;
}

.severity-group-header {
    padding: 1rem 1.5rem;
    color: white;
    font-weight: 600;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.severity-critical .severity-group-header { background: #dc2626; }
.severity-high .severity-group-header { background: #ea580c; }
.severity-medium .severity-group-header { background: #d97706; }
.severity-low .severity-group-header { background: #16a34a; }

.severity-count {
    background: rgba(255,255,255,0.2);
    padding: 0.3rem 0.8rem;
    border-radius: 12px;
    font-size: 0.9rem;
}

.vulnerability-cards {
    padding: 1rem;
}

.professional-vulnerability-card {
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    margin-bottom: 1rem;
    overflow: hidden;
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.professional-vulnerability-card.critical { border-left: 4px solid #dc2626; }
.professional-vulnerability-card.high { border-left: 4px solid #ea580c; }
.professional-vulnerability-card.medium { border-left: 4px solid #d97706; }
.professional-vulnerability-card.low { border-left: 4px solid #16a34a; }

.vuln-card-header {
    padding: 1.5rem;
    background: #f8fafc;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.vuln-title {
    margin: 0 0 0.5rem 0;
    color: #1f2937;
    font-size: 1.2rem;
}

.vuln-meta {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.vuln-location, .vuln-cvss, .vuln-cves {
    background: #e5e7eb;
    padding: 0.2rem 0.6rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 500;
}

.vuln-cvss { background: #374151; color: white; cursor: pointer; }
.vuln-cves { background: #dc2626; color: white; cursor: pointer; }

.vuln-severity-badge {
    padding: 0.4rem 0.8rem;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 700;
    color: white;
}

.vuln-severity-badge.severity-critical { background: #dc2626; }
.vuln-severity-badge.severity-high { background: #ea580c; }
.vuln-severity-badge.severity-medium { background: #d97706; }
.vuln-severity-badge.severity-low { background: #16a34a; }

.vuln-card-content {
    padding: 1.5rem;
}

.vuln-description, .vuln-impact, .vuln-evidence, .vuln-cve-list {
    margin-bottom: 1.2rem;
}

.vuln-description strong, .vuln-impact strong, .vuln-evidence strong, .vuln-cve-list strong {
    color: #374151;
    display: block;
    margin-bottom: 0.5rem;
}

.evidence-content {
    background: #f8fafc;
    border: 1px solid #e5e7eb;
    border-radius: 4px;
    padding: 1rem;
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    overflow-x: auto;
}

.cve-tags {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.cve-tag {
    background: #dc2626;
    color: white;
    padding: 0.3rem 0.6rem;
    border-radius: 4px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: background 0.3s ease;
}

.cve-tag:hover {
    background: #b91c1c;
}

.vuln-card-footer {
    padding: 1.5rem;
    background: #f0fdf4;
    border-top: 1px solid #dcfce7;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1rem;
}

.remediation-section {
    flex: 1;
}

.remediation-section strong {
    color: #374151;
    display: block;
    margin-bottom: 0.5rem;
}

.btn-remediation {
    background: #16a34a;
    color: white;
    border: none;
    padding: 0.7rem 1.2rem;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.3s ease;
    white-space: nowrap;
}

.btn-remediation:hover {
    background: #15803d;
}

/* Responsive Design */
@media (max-width: 768px) {
    .scan-header-content {
        flex-direction: column;
        gap: 1rem;
    }
    
    .meta-grid {
        grid-template-columns: 1fr;
    }
    
    .overview-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .risk-banner-content {
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
    }
    
    .vuln-card-header {
        flex-direction: column;
        gap: 1rem;
    }
    
    .vuln-card-footer {
        flex-direction: column;
    }
    
    .btn-remediation {
        width: 100%;
    }
}
`;

// Inject CSS
const style = document.createElement('style');
style.textContent = professionalCSS;
document.head.appendChild(style);

function createTechnologyStack(websiteInfo) {
    // Safely access technology data with fallbacks
    const techData = websiteInfo || {};
    const technologies = techData.technologies || [];
    const serverInfo = techData.server_info || {};
    const headers = techData.headers || {};
    
    const section = document.createElement('div');
    section.className = 'technology-stack-section';
    
    section.innerHTML = `
        <div class="section-header">
            <h2><i class="fas fa-layer-group"></i> Technology Stack Analysis</h2>
        </div>
        <div class="tech-stack-content">
            ${technologies.length > 0 ? createTechStackGrid(technologies, serverInfo, headers) : createNoTechDetected()}
            ${createSecurityImplications(technologies)}
            ${createServerInfo(serverInfo, headers)}
        </div>
    `;
    
    return section;
}

function createTechStackGrid(technologies, serverInfo, headers) {
    // Categorize technologies
    const categorized = categorizeTechnologies(technologies, serverInfo, headers);
    
    return `
        <div class="tech-stack-grid">
            <div class="tech-category">
                <h3><i class="fas fa-server"></i> Web Server & Infrastructure</h3>
                <div class="tech-items">
                    ${categorized.servers.map(tech => createTechItem(tech, 'server')).join('')}
                    ${categorized.cdn.map(tech => createTechItem(tech, 'cdn')).join('')}
                </div>
            </div>
            
            <div class="tech-category">
                <h3><i class="fas fa-code"></i> Programming & Frameworks</h3>
                <div class="tech-items">
                    ${categorized.frameworks.map(tech => createTechItem(tech, 'framework')).join('')}
                    ${categorized.languages.map(tech => createTechItem(tech, 'language')).join('')}
                </div>
            </div>
            
            <div class="tech-category">
                <h3><i class="fas fa-database"></i> Database & Backend</h3>
                <div class="tech-items">
                    ${categorized.databases.map(tech => createTechItem(tech, 'database')).join('')}
                    ${categorized.caching.map(tech => createTechItem(tech, 'cache')).join('')}
                </div>
            </div>
            
            <div class="tech-category">
                <h3><i class="fas fa-puzzle-piece"></i> Frontend & Libraries</h3>
                <div class="tech-items">
                    ${categorized.frontend.map(tech => createTechItem(tech, 'frontend')).join('')}
                    ${categorized.libraries.map(tech => createTechItem(tech, 'library')).join('')}
                </div>
            </div>
        </div>
    `;
}

function categorizeTechnologies(technologies, serverInfo, headers) {
    const categorized = {
        servers: [],
        cdn: [],
        frameworks: [],
        languages: [],
        databases: [],
        caching: [],
        frontend: [],
        libraries: []
    };
    
    technologies.forEach(tech => {
        const techLower = tech.toLowerCase();
        
        // Web servers
        if (techLower.includes('apache') || techLower.includes('nginx') || techLower.includes('iis')) {
            categorized.servers.push(tech);
        }
        // CDN
        else if (techLower.includes('cloudflare') || techLower.includes('akamai') || techLower.includes('cloudfront')) {
            categorized.cdn.push(tech);
        }
        // Frameworks
        else if (techLower.includes('wordpress') || techLower.includes('drupal') || techLower.includes('joomla') || 
                 techLower.includes('laravel') || techLower.includes('django') || techLower.includes('express') ||
                 techLower.includes('react') || techLower.includes('vue') || techLower.includes('angular')) {
            categorized.frameworks.push(tech);
        }
        // Programming languages
        else if (techLower.includes('php') || techLower.includes('asp') || techLower.includes('java') || 
                 techLower.includes('python') || techLower.includes('ruby') || techLower.includes('node')) {
            categorized.languages.push(tech);
        }
        // Databases
        else if (techLower.includes('mysql') || techLower.includes('postgresql') || techLower.includes('mongodb') || 
                 techLower.includes('sqlite') || techLower.includes('oracle') || techLower.includes('redis')) {
            categorized.databases.push(tech);
        }
        // Caching
        else if (techLower.includes('redis') || techLower.includes('memcached') || techLower.includes('varnish')) {
            categorized.caching.push(tech);
        }
        // Frontend
        else if (techLower.includes('bootstrap') || techLower.includes('foundation') || techLower.includes('material')) {
            categorized.frontend.push(tech);
        }
        // Libraries
        else if (techLower.includes('jquery') || techLower.includes('axios') || techLower.includes('lodash')) {
            categorized.libraries.push(tech);
        }
        // Default to libraries for unknown
        else {
            categorized.libraries.push(tech);
        }
    });
    
    // Add server info from headers
    if (headers.Server && !categorized.servers.some(s => s.toLowerCase().includes(headers.Server.toLowerCase()))) {
        categorized.servers.push(headers.Server);
    }
    
    if (headers['X-Powered-By']) {
        const poweredBy = headers['X-Powered-By'];
        if (!categorized.languages.some(l => l.toLowerCase().includes(poweredBy.toLowerCase()))) {
            categorized.languages.push(poweredBy);
        }
    }
    
    return categorized;
}

function createTechItem(tech, type) {
    const icons = {
        server: 'fa-server',
        cdn: 'fa-cloud',
        framework: 'fa-cubes',
        language: 'fa-code',
        database: 'fa-database',
        cache: 'fa-bolt',
        frontend: 'fa-palette',
        library: 'fa-book'
    };
    
    return `
        <div class="tech-item tech-${type}">
            <div class="tech-icon">
                <i class="fas ${icons[type] || 'fa-cube'}"></i>
            </div>
            <div class="tech-name">${tech}</div>
            <div class="tech-risk ${getTechRiskLevel(tech, type)}">
                <i class="fas ${getTechRiskIcon(tech, type)}"></i>
            </div>
        </div>
    `;
}

function getTechRiskLevel(tech, type) {
    const techLower = tech.toLowerCase();
    
    // High risk technologies
    if ((techLower.includes('php') && techLower.includes('5.')) || 
        (techLower.includes('jquery') && techLower.includes('1.')) ||
        (techLower.includes('wordpress') && techLower.includes('4.'))) {
        return 'high-risk';
    }
    
    // Medium risk
    if (techLower.includes('apache/2.2') || techLower.includes('iis/7') || techLower.includes('php/7.0')) {
        return 'medium-risk';
    }
    
    return 'low-risk';
}

function getTechRiskIcon(tech, type) {
    const riskLevel = getTechRiskLevel(tech, type);
    
    switch(riskLevel) {
        case 'high-risk': return 'fa-exclamation-triangle';
        case 'medium-risk': return 'fa-exclamation-circle';
        default: return 'fa-check-circle';
    }
}

function createNoTechDetected() {
    return `
        <div class="no-tech-detected">
            <div class="no-tech-icon">
                <i class="fas fa-search"></i>
            </div>
            <div class="no-tech-content">
                <h3>No Technologies Detected</h3>
                <p>Unable to automatically detect the technology stack. This could be due to:</p>
                <ul>
                    <li>Custom-built application</li>
                    <li>Heavily modified framework</li>
                    <li>Security headers hiding technology information</li>
                    <li>CDN obscuring server details</li>
                </ul>
            </div>
        </div>
    `;
}

function createSecurityImplications(technologies) {
    const implications = analyzeSecurityImplications(technologies);
    
    if (implications.length === 0) {
        return '';
    }
    
    return `
        <div class="security-implications">
            <h3><i class="fas fa-shield-alt"></i> Security Implications</h3>
            <div class="implications-list">
                ${implications.map(imp => `
                    <div class="implication-item implication-${imp.severity}">
                        <div class="implication-icon">
                            <i class="fas ${getImplicationIcon(imp.severity)}"></i>
                        </div>
                        <div class="implication-content">
                            <h4>${imp.title}</h4>
                            <p>${imp.description}</p>
                            ${imp.recommendation ? `<div class="recommendation">${imp.recommendation}</div>` : ''}
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

function analyzeSecurityImplications(technologies) {
    const implications = [];
    const techLower = technologies.map(t => t.toLowerCase());
    
    // Check for outdated PHP
    if (techLower.some(t => t.includes('php') && (t.includes('5.') || t.includes('7.0') || t.includes('7.1')))) {
        implications.push({
            severity: 'high',
            title: 'Outdated PHP Version',
            description: 'Older PHP versions contain known security vulnerabilities and lack security features.',
            recommendation: 'Upgrade to PHP 8.1 or later for security patches and improvements.'
        });
    }
    
    // Check for WordPress
    if (techLower.some(t => t.includes('wordpress'))) {
        implications.push({
            severity: 'medium',
            title: 'WordPress Security Considerations',
            description: 'WordPress sites require regular updates for core, themes, and plugins to maintain security.',
            recommendation: 'Implement automatic updates and regular security scanning for WordPress components.'
        });
    }
    
    // Check for jQuery
    if (techLower.some(t => t.includes('jquery') && t.includes('1.'))) {
        implications.push({
            severity: 'high',
            title: 'Outdated jQuery Version',
            description: 'jQuery versions 1.x and 2.x contain known XSS and security vulnerabilities.',
            recommendation: 'Upgrade to jQuery 3.x or later, or consider removing jQuery dependency.'
        });
    }
    
    // Check for Apache
    if (techLower.some(t => t.includes('apache/2.2') || t.includes('apache/2.4.49'))) {
        implications.push({
            severity: 'critical',
            title: 'Vulnerable Apache Version',
            description: 'Specific Apache versions contain critical path traversal and RCE vulnerabilities.',
            recommendation: 'Immediately update Apache to the latest stable version.'
        });
    }
    
    // Check for exposed technology information
    if (techLower.length > 5) {
        implications.push({
            severity: 'low',
            title: 'Technology Information Exposure',
            description: 'Multiple technologies are exposed, which could aid attackers in targeted attacks.',
            recommendation: 'Consider obscuring technology headers and version information.'
        });
    }
    
    return implications;
}

function getImplicationIcon(severity) {
    switch(severity) {
        case 'critical': return 'fa-skull-crossbones';
        case 'high': return 'fa-exclamation-triangle';
        case 'medium': return 'fa-exclamation-circle';
        case 'low': return 'fa-info-circle';
        default: return 'fa-question-circle';
    }
}

function createServerInfo(serverInfo, headers) {
    const hasServerInfo = serverInfo && Object.keys(serverInfo).length > 0;
    const hasHeaders = headers && Object.keys(headers).length > 0;
    
    if (!hasServerInfo && !hasHeaders) {
        return '';
    }
    
    return `
        <div class="server-info-section">
            <h3><i class="fas fa-info-circle"></i> Server Information</h3>
            <div class="server-info-grid">
                ${hasServerInfo ? `
                    <div class="server-info-category">
                        <h4>Server Details</h4>
                        <div class="info-items">
                            ${Object.entries(serverInfo).map(([key, value]) => `
                                <div class="info-item">
                                    <strong>${formatKey(key)}:</strong>
                                    <span>${Array.isArray(value) ? value.join(', ') : value}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                ${hasHeaders ? `
                    <div class="server-info-category">
                        <h4>HTTP Headers</h4>
                        <div class="info-items">
                            ${Object.entries(headers).slice(0, 8).map(([key, value]) => `
                                <div class="info-item">
                                    <strong>${key}:</strong>
                                    <span>${value}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            </div>
        </div>
    `;
}

function formatKey(key) {
    return key.split('_').map(word => 
        word.charAt(0).toUpperCase() + word.slice(1)
    ).join(' ');
}

function createProfessionalRecommendations(recommendations) {
    const recs = Array.isArray(recommendations) ? recommendations : [];
    
    const section = document.createElement('div');
    section.className = 'professional-recommendations-section';
    
    section.innerHTML = `
        <div class="section-header">
            <h2><i class="fas fa-lightbulb"></i> Security Recommendations</h2>
            <span class="recommendations-count">${recs.length} Recommendations</span>
        </div>
        <div class="recommendations-content">
            ${recs.length > 0 ? createRecommendationsList(recs) : createDefaultRecommendations()}
        </div>
    `;
    
    return section;
}

function createRecommendationsList(recommendations) {
    // Categorize recommendations by priority
    const categorized = categorizeRecommendations(recommendations);
    
    return `
        <div class="recommendations-grid">
            ${categorized.critical.length > 0 ? `
                <div class="recommendation-category critical">
                    <h3><i class="fas fa-skull-crossbones"></i> Critical Priority</h3>
                    <div class="recommendation-list">
                        ${categorized.critical.map(rec => createRecommendationItem(rec, 'critical')).join('')}
                    </div>
                </div>
            ` : ''}
            
            ${categorized.high.length > 0 ? `
                <div class="recommendation-category high">
                    <h3><i class="fas fa-exclamation-triangle"></i> High Priority</h3>
                    <div class="recommendation-list">
                        ${categorized.high.map(rec => createRecommendationItem(rec, 'high')).join('')}
                    </div>
                </div>
            ` : ''}
            
            ${categorized.medium.length > 0 ? `
                <div class="recommendation-category medium">
                    <h3><i class="fas fa-exclamation-circle"></i> Medium Priority</h3>
                    <div class="recommendation-list">
                        ${categorized.medium.map(rec => createRecommendationItem(rec, 'medium')).join('')}
                    </div>
                </div>
            ` : ''}
            
            ${categorized.low.length > 0 ? `
                <div class="recommendation-category low">
                    <h3><i class="fas fa-info-circle"></i> Low Priority</h3>
                    <div class="recommendation-list">
                        ${categorized.low.map(rec => createRecommendationItem(rec, 'low')).join('')}
                    </div>
                </div>
            ` : ''}
        </div>
        
        <div class="recommendations-actions">
            <button class="btn btn-primary" onclick="generateActionPlan()">
                <i class="fas fa-download"></i> Download Action Plan
            </button>
            <button class="btn btn-outline" onclick="showImplementationGuide()">
                <i class="fas fa-book"></i> View Implementation Guide
            </button>
        </div>
    `;
}

function categorizeRecommendations(recommendations) {
    const categorized = {
        critical: [],
        high: [],
        medium: [],
        low: []
    };
    
    recommendations.forEach(rec => {
        const recLower = rec.toLowerCase();
        
        if (recLower.includes(' immediate') || recLower.includes('critical') || recLower.includes('emergency')) {
            categorized.critical.push(rec);
        } else if (recLower.includes(' urgent') || recLower.includes('high')) {
            categorized.high.push(rec);
        } else if (recLower.includes('medium') || recLower.includes('important')) {
            categorized.medium.push(rec);
        } else {
            categorized.low.push(rec);
        }
    });
    
    return categorized;
}

function createRecommendationItem(recommendation, priority) {
    const id = 'rec-' + Math.random().toString(36).substr(2, 9);
    return `
        <div class="recommendation-item priority-${priority}">
            <div class="recommendation-checkbox">
                <input type="checkbox" id="${id}" onchange="trackRecommendationProgress(this)">
            </div>
            <div class="recommendation-content">
                <label for="${id}" class="recommendation-text">${recommendation}</label>
                <div class="recommendation-meta">
                    <span class="estimated-time">${getEstimatedTime(priority)}</span>
                    <span class="implementation-difficulty">${getDifficulty(priority)}</span>
                </div>
            </div>
            <div class="recommendation-actions">
                <button class="btn-icon" onclick="showRecommendationDetails('${recommendation}')" title="View Details">
                    <i class="fas fa-info-circle"></i>
                </button>
                <button class="btn-icon" onclick="addToActionPlan('${recommendation}')" title="Add to Action Plan">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
    `;
}

function generateId() {
    return Math.random().toString(36).substr(2, 9);
}

function getEstimatedTime(priority) {
    const times = {
        critical: '1-2 days',
        high: '3-7 days',
        medium: '1-2 weeks',
        low: 'Next quarter'
    };
    return times[priority] || 'TBD';
}

function getDifficulty(priority) {
    const difficulties = {
        critical: 'High',
        high: 'Medium-High',
        medium: 'Medium',
        low: 'Low'
    };
    return difficulties[priority] || 'Medium';
}

function createDefaultRecommendations() {
    return `
        <div class="default-recommendations">
            <div class="default-recommendation">
                <h3><i class="fas fa-shield-alt"></i> General Security Best Practices</h3>
                <div class="recommendation-list">
                    ${getDefaultRecommendations().map(rec => `
                        <div class="recommendation-item">
                            <div class="recommendation-checkbox">
                                <input type="checkbox" id="def-rec-${Math.random().toString(36).substr(2, 9)}">
                            </div>
                            <div class="recommendation-content">
                                <label>${rec}</label>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;
}

function getDefaultRecommendations() {
    return [
        'Implement Content Security Policy (CSP) header',
        'Set X-Frame-Options to DENY or SAMEORIGIN',
        'Enable HTTP Strict Transport Security (HSTS)',
        'Ensure all cookies have Secure and HttpOnly flags',
        'Implement proper input validation and output encoding',
        'Keep all software components updated and patched',
        'Conduct regular security awareness training',
        'Implement automated security testing in CI/CD',
        'Establish incident response procedures',
        'Perform regular security audits and penetration testing'
    ];
}

function trackRecommendationProgress(checkbox) {
    const total = document.querySelectorAll('.recommendation-checkbox input[type="checkbox"]').length;
    const completed = document.querySelectorAll('.recommendation-checkbox input[type="checkbox"]:checked').length;
    const progress = total > 0 ? Math.round((completed / total) * 100) : 0;
    
    // Update progress display if it exists
    const progressElement = document.querySelector('.recommendations-progress');
    if (progressElement) {
        progressElement.innerHTML = `Implementation Progress: ${progress}%`;
    }
    
    console.log(`Recommendation progress: ${progress}% (${completed}/${total})`);
}

function showRecommendationDetails(recommendation) {
    alert(`Detailed view for: ${recommendation}\n\nThis would show implementation steps, code examples, and testing procedures.`);
}

function addToActionPlan(recommendation) {
    showNotification(`Added to action plan: ${recommendation}`, 'success');
}

function generateActionPlan() {
    showNotification('Generating comprehensive action plan PDF...', 'info');
    // In a real implementation, this would generate and download a PDF
    setTimeout(() => {
        showNotification('Action plan generated successfully!', 'success');
    }, 2000);
}

function showImplementationGuide() {
    showNotification('Opening implementation guide...', 'info');
    // In a real implementation, this would open a detailed guide
}


function createScanDetails(data) {
    const scanData = data || {};
    
    const section = document.createElement('div');
    section.className = 'scan-details-section';
    
    section.innerHTML = `
        <div class="section-header">
            <h2><i class="fas fa-info-circle"></i> Scan Details & Metadata</h2>
        </div>
        <div class="scan-details-content">
            <div class="details-grid">
                <div class="detail-category">
                    <h3><i class="fas fa-cog"></i> Scan Configuration</h3>
                    <div class="detail-items">
                        ${createScanConfigItems(scanData)}
                    </div>
                </div>
                
                <div class="detail-category">
                    <h3><i class="fas fa-chart-line"></i> Performance Metrics</h3>
                    <div class="detail-items">
                        ${createPerformanceItems(scanData)}
                    </div>
                </div>
                
                <div class="detail-category">
                    <h3><i class="fas fa-database"></i> Data Collection</h3>
                    <div class="detail-items">
                        ${createDataCollectionItems(scanData)}
                    </div>
                </div>
                
                <div class="detail-category">
                    <h3><i class="fas fa-history"></i> Scan History</h3>
                    <div class="detail-items">
                        ${createHistoryItems(scanData)}
                    </div>
                </div>
            </div>
            
            <div class="scan-export-actions">
                <button class="btn btn-outline" onclick="exportScanData()">
                    <i class="fas fa-download"></i> Export Raw Data
                </button>
                <button class="btn btn-outline" onclick="showScanLogs()">
                    <i class="fas fa-file-alt"></i> View Scan Logs
                </button>
                <button class="btn btn-primary" onclick="scheduleRescan()">
                    <i class="fas fa-redo"></i> Schedule Rescan
                </button>
            </div>
        </div>
    `;
    
    return section;
}

function createScanConfigItems(scanData) {
    const items = [
        { label: 'Scan Type', value: scanData.scan_type || 'Quick Scan' },
        { label: 'Target URL', value: scanData.website_info?.url || 'Unknown' },
        { label: 'Scan Intensity', value: scanData.scan_metrics?.scan_intensity || 'Standard' },
        { label: 'Test Coverage', value: scanData.scan_metrics?.scan_coverage || 'Comprehensive' },
        { label: 'User Agent', value: scanData.website_info?.headers?.['User-Agent'] || 'Security Scanner' },
        { label: 'Timeout Settings', value: '15 seconds' }
    ];
    
    return items.map(item => `
        <div class="detail-item">
            <strong>${item.label}:</strong>
            <span>${item.value}</span>
        </div>
    `).join('');
}

function createPerformanceItems(scanData) {
    const metrics = scanData.scan_metrics || {};
    
    const items = [
        { label: 'Total Duration', value: metrics.scan_duration || 'Unknown' },
        { label: 'Tests Executed', value: metrics.total_tests || 0 },
        { label: 'Success Rate', value: metrics.success_rate ? `${metrics.success_rate}%` : 'N/A' },
        { label: 'Memory Usage', value: '~' + (metrics.total_tests * 0.5).toFixed(1) + ' MB' },
        { label: 'Network Requests', value: metrics.total_tests ? metrics.total_tests * 2 : 'N/A' },
        { label: 'Data Transferred', value: '~' + (metrics.total_tests * 2.5).toFixed(1) + ' KB' }
    ];
    
    return items.map(item => `
        <div class="detail-item">
            <strong>${item.label}:</strong>
            <span>${item.value}</span>
        </div>
    `).join('');
}

function createDataCollectionItems(scanData) {
    const websiteInfo = scanData.website_info || {};
    
    const items = [
        { label: 'Headers Collected', value: Object.keys(websiteInfo.headers || {}).length },
        { label: 'Technologies Detected', value: (websiteInfo.technologies || []).length },
        { label: 'Security Headers', value: Object.keys(websiteInfo.security_headers || {}).length },
        { label: 'Content Analysis', value: websiteInfo.content_analysis ? 'Completed' : 'Not available' },
        { label: 'SSL Information', value: websiteInfo.ssl_info ? 'Collected' : 'Not available' },
        { label: 'DNS Records', value: Object.keys(websiteInfo.dns_info || {}).length }
    ];
    
    return items.map(item => `
        <div class="detail-item">
            <strong>${item.label}:</strong>
            <span>${item.value}</span>
        </div>
    `).join('');
}

function createHistoryItems(scanData) {
    const items = [
        { label: 'Scan Timestamp', value: scanData.timestamp || new Date().toISOString() },
        { label: 'Scan ID', value: generateScanId() },
        { label: 'Scanner Version', value: '2.0.0' },
        { label: 'Report Format', value: 'Professional' },
        { label: 'Data Version', value: '1.2' },
        { label: 'Export Ready', value: 'Yes' }
    ];
    
    return items.map(item => `
        <div class="detail-item">
            <strong>${item.label}:</strong>
            <span>${item.value}</span>
        </div>
    `).join('');
}

function generateScanId() {
    return 'SCAN-' + Date.now() + '-' + Math.random().toString(36).substr(2, 6).toUpperCase();
}

function exportScanData() {
    alert('Exporting raw scan data as JSON...');
    // Implementation would create and download JSON file
}

function showScanLogs() {
    alert('Opening scan execution logs...');
}

function scheduleRescan() {
    const modal = document.createElement('div');
    modal.className = 'rescan-modal';
    modal.innerHTML = `
        <div class="modal-overlay" onclick="closeRescanModal()">
            <div class="modal-content" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <h2><i class="fas fa-redo"></i> Schedule Rescan</h2>
                    <button class="modal-close" onclick="closeRescanModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="rescan-options">
                        <div class="option-group">
                            <label>Rescan Frequency</label>
                            <select id="rescan-frequency">
                                <option value="daily">Daily</option>
                                <option value="weekly" selected>Weekly</option>
                                <option value="monthly">Monthly</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        
                        <div class="option-group">
                            <label>Scan Type</label>
                            <select id="rescan-type">
                                <option value="quick">Quick Scan</option>
                                <option value="full" selected>Full Scan</option>
                                <option value="cms">CMS Scan</option>
                                <option value="api">API Scan</option>
                            </select>
                        </div>
                        
                        <div class="option-group">
                            <label>Notification Settings</label>
                            <div class="checkbox-group">
                                <label>
                                    <input type="checkbox" id="email-notifications" checked>
                                    Email notifications
                                </label>
                                <label>
                                    <input type="checkbox" id="critical-alerts" checked>
                                    Critical alerts only
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeRescanModal()">
                        Cancel
                    </button>
                    <button class="btn btn-primary" onclick="confirmRescanSchedule()">
                        Schedule Rescan
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function closeRescanModal() {
    const modal = document.querySelector('.rescan-modal');
    if (modal) {
        modal.remove();
    }
}

function confirmRescanSchedule() {
    const frequency = document.getElementById('rescan-frequency').value;
    const scanType = document.getElementById('rescan-type').value;
    
    showNotification(`Rescan scheduled: ${frequency} ${scanType} scans`, 'success');
    closeRescanModal();
}

function showNotification(message, type = 'info') {
    // Remove existing notification if any
    const existingNotification = document.querySelector('.global-notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    const notification = document.createElement('div');
    notification.className = `global-notification notification-${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <i class="fas fa-${getNotificationIcon(type)}"></i>
            <span>${message}</span>
            <button class="notification-close" onclick="this.parentElement.parentElement.remove()">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    // Add styles if not already added
    if (!document.querySelector('#notification-styles')) {
        const styles = document.createElement('style');
        styles.id = 'notification-styles';
        styles.textContent = `
            .global-notification {
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                min-width: 300px;
                max-width: 500px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                animation: slideInRight 0.3s ease;
            }
            .notification-content {
                display: flex;
                align-items: center;
                padding: 1rem;
                gap: 0.75rem;
            }
            .notification-info { background: #dbeafe; color: #1e40af; border-left: 4px solid #3b82f6; }
            .notification-success { background: #d1fae5; color: #065f46; border-left: 4px solid #10b981; }
            .notification-warning { background: #fef3c7; color: #92400e; border-left: 4px solid #f59e0b; }
            .notification-error { background: #fee2e2; color: #991b1b; border-left: 4px solid #ef4444; }
            .notification-close {
                background: none;
                border: none;
                margin-left: auto;
                cursor: pointer;
                opacity: 0.7;
            }
            .notification-close:hover { opacity: 1; }
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        document.head.appendChild(styles);
    }
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 5000);
}

function getNotificationIcon(type) {
    const icons = {
        'info': 'info-circle',
        'success': 'check-circle',
        'warning': 'exclamation-triangle',
        'error': 'exclamation-circle'
    };
    return icons[type] || 'info-circle';
}



// FOR SOLUTION CHAT

let currentVulnerability = null;
let chatHistory = [];
let aiFixModal = null;

function createAIFixModal() {
    // Create modal HTML structure
    const modalHTML = `
        <div id="aiFixModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>
                        <i class="fas fa-robot"></i>
                        AI Fix Assistant
                        <span id="modalVulnerabilityType" class="vulnerability-type-badge"></span>
                    </h3>
                    <span class="close-modal">&times;</span>
                </div>
                
                <div class="modal-body">
                    <div class="chat-container">
                        <div id="chatMessages" class="chat-messages">
                            <!-- AI messages will appear here -->
                        </div>
                        
                        <div class="chat-input-container">
                            <div class="typing-indicator" id="typingIndicator" style="display: none;">
                                <i class="fas fa-robot"></i>
                                <span>AI is generating step-by-step fix...</span>
                                <div class="typing-dots">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                            </div>
                            
                            <div class="input-group">
                                <input 
                                    type="text" 
                                    id="userQuestion" 
                                    placeholder="Ask a specific question about this vulnerability..."
                                    disabled
                                >
                                <button id="sendQuestion" class="btn-send" disabled>
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button id="copyFix" class="btn-secondary" disabled>
                        <i class="fas fa-copy"></i> Copy Fix to Clipboard
                    </button>
                    <button id="exportFix" class="btn-secondary" disabled>
                        <i class="fas fa-download"></i> Export as Text
                    </button>
                </div>
            </div>
        </div>
    `;

    // Add modal to the page
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modalHTML;
    document.body.appendChild(modalContainer);

    // Store reference to the modal
    aiFixModal = document.getElementById('aiFixModal');
    
    // Initialize modal functionality
    initializeAIFixModal();
    
    // Inject CSS styles
    injectAIFixModalCSS();
}

function injectAIFixModalCSS() {
    const css = `
        /* AI Fix Assistant Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 2% auto;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .modal-header h3 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.25rem;
        }

        .vulnerability-type-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .close-modal {
            font-size: 1.5rem;
            cursor: pointer;
            background: none;
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }

        .close-modal:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            flex: 1;
            padding: 0;
            overflow: hidden;
        }

        .chat-container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            max-height: 400px;
            background: #f8fafc;
        }

        .chat-message {
            margin-bottom: 1.5rem;
            padding: 1rem 1.25rem;
            border-radius: 12px;
            line-height: 1.5;
            animation: messageSlideIn 0.3s ease-out;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-ai {
            background: white;
            border: 1px solid #e5e7eb;
            border-left: 4px solid #3b82f6;
        }

        .message-user {
            background: #3b82f6;
            color: white;
            margin-left: 2rem;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .message-content {
            font-size: 0.95rem;
        }

        .step-by-step-fix {
            margin-top: 1rem;
            padding: 1rem;
            background: #f0f9ff;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }

        .step-item {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            padding: 0.75rem;
            background: white;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }

        .step-number {
            background: #3b82f6;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
            font-size: 0.9rem;
        }

        .code-snippet {
            background: #1f2937;
            color: #e5e7eb;
            padding: 1rem;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            margin: 0.5rem 0;
            overflow-x: auto;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: #f0f9ff;
            border-radius: 8px;
            margin-bottom: 1rem;
            color: #3b82f6;
            font-size: 0.9rem;
        }

        .typing-dots {
            display: flex;
            gap: 3px;
        }

        .typing-dots span {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #3b82f6;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .chat-input-container {
            padding: 1.5rem;
            border-top: 1px solid #e5e7eb;
            background: white;
        }

        .input-group {
            display: flex;
            gap: 0.75rem;
        }

        #userQuestion {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: border-color 0.3s ease;
        }

        #userQuestion:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn-send {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-send:hover:not(:disabled) {
            background: #2563eb;
        }

        .btn-send:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
            background: #f8fafc;
            border-radius: 0 0 12px 12px;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
            border: none;
            padding: 0.6rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background 0.3s ease;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #4b5563;
        }

        .btn-secondary:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                margin: 1% auto;
                height: 95vh;
            }
            
            .modal-header {
                padding: 1rem;
            }
            
            .chat-messages {
                padding: 1rem;
                max-height: 300px;
            }
            
            .step-item {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
    `;

    const style = document.createElement('style');
    style.textContent = css;
    document.head.appendChild(style);
}

function initializeAIFixModal() {
    if (!aiFixModal) return;

    const closeBtn = aiFixModal.querySelector('.close-modal');
    const sendBtn = aiFixModal.querySelector('#sendQuestion');
    const userInput = aiFixModal.querySelector('#userQuestion');
    const copyBtn = aiFixModal.querySelector('#copyFix');
    const exportBtn = aiFixModal.querySelector('#exportFix');

    // Close modal when clicking X
    closeBtn.addEventListener('click', closeAIFixModal);

    // Close modal when clicking outside
    aiFixModal.addEventListener('click', (e) => {
        if (e.target === aiFixModal) {
            closeAIFixModal();
        }
    });

    // Send message on button click
    sendBtn.addEventListener('click', sendUserMessage);

    // Send message on Enter key
    userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendUserMessage();
        }
    });

    // Copy fix to clipboard
    copyBtn.addEventListener('click', copyFixToClipboard);

    // Export fix as text file
    exportBtn.addEventListener('click', exportFixAsText);

    // Close on Escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && aiFixModal.style.display === 'block') {
            closeAIFixModal();
        }
    });
}

function openAIFixModal(vulnerability) {
    // Create modal if it doesn't exist
    if (!aiFixModal) {
        createAIFixModal();
    }

    currentVulnerability = vulnerability;
    chatHistory = [];
    
    const vulnerabilityType = aiFixModal.querySelector('#modalVulnerabilityType');
    const chatMessages = aiFixModal.querySelector('#chatMessages');
    const userInput = aiFixModal.querySelector('#userQuestion');
    const sendBtn = aiFixModal.querySelector('#sendQuestion');
    const copyBtn = aiFixModal.querySelector('#copyFix');
    const exportBtn = aiFixModal.querySelector('#exportFix');

    // Update modal header with vulnerability type
    vulnerabilityType.textContent = vulnerability.type;
    vulnerabilityType.className = `vulnerability-type-badge severity-${vulnerability.severity.toLowerCase()}`;

    // Clear chat messages
    chatMessages.innerHTML = '';
    
    // Enable/disable buttons
    userInput.disabled = false;
    sendBtn.disabled = false;
    copyBtn.disabled = true;
    exportBtn.disabled = true;

    // Show modal
    aiFixModal.style.display = 'block';

    // Generate initial AI response
    generateAIFix(vulnerability);
}

function closeAIFixModal() {
    if (aiFixModal) {
        aiFixModal.style.display = 'none';
    }
    currentVulnerability = null;
    chatHistory = [];
}

function generateAIFix(vulnerability) {
    showTypingIndicator();
    
    const prompt = createVulnerabilityPrompt(vulnerability);
    
    console.log('Generating AI fix for:', vulnerability.type);
    console.log('Prompt:', prompt);
    
    // Call Ollama API with timeout
    const timeoutPromise = new Promise((_, reject) => {
        setTimeout(() => reject(new Error('AI response timeout after 30 seconds')), 600000);
    });
    
    Promise.race([
        callOllamaAPI(prompt),
        //callOllamaDirect(prompt),
        timeoutPromise
    ])
        .then(aiResponse => {
            hideTypingIndicator();
            
            console.log('AI Response received:', typeof aiResponse, aiResponse);
            
            // Ensure response is a string
            let responseText = '';
            if (typeof aiResponse === 'string') {
                responseText = aiResponse;
            } else if (aiResponse && typeof aiResponse === 'object') {
                responseText = JSON.stringify(aiResponse, null, 2);
            } else {
                responseText = String(aiResponse);
            }
            
            // Clean up the response
            responseText = cleanAIResponse(responseText);
            
            displayAIResponse(responseText, true);
            enableActionButtons();
        })
        .catch(error => {
            hideTypingIndicator();
            console.error('Error generating AI fix:', error);
            
            // Provide a fallback response if AI fails
            const fallbackResponse = createFallbackFix(vulnerability);
            displayAIResponse(fallbackResponse, true);
            enableActionButtons();
        });
}

//CALL OLLAMA DIRECTLY
async function callOllamaDirect(prompt) {
    try {
        console.log('Calling Ollama directly...');
        
        // Adjust this URL to match your Ollama setup
        const ollamaUrl = 'http://localhost:11434/api/generate';
        
        const response = await fetch(ollamaUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                model: 'gemma3:4b', // Use smaller model for speed
                prompt: prompt,
                stream: false,
                options: {
                    temperature: 0.7,
                    num_predict: 1024
                }
            })
        });
        
        if (!response.ok) {
            throw new Error(`Ollama error: ${response.status}`);
        }
        
        const data = await response.json();
        return data.response || 'No response from Ollama';
        
    } catch (error) {
        console.error('Direct Ollama call failed:', error);
        throw error;
    }
}

function cleanAIResponse(response) {
    if (!response) return 'No response generated.';
    
    let cleaned = response;
    
    // Remove any JSON artifacts
    cleaned = cleaned.replace(/^\s*\{.*?"raw_response"\s*:\s*"/, '');
    cleaned = cleaned.replace(/"\s*\}\s*$/, '');
    cleaned = cleaned.replace(/\\"/g, '"');
    cleaned = cleaned.replace(/\\n/g, '\n');
    cleaned = cleaned.replace(/\\t/g, '\t');
    cleaned = cleaned.replace(/\\u([\d\w]{4})/gi, (match, grp) => {
        return String.fromCharCode(parseInt(grp, 16));
    });
    
    // Remove multiple concatenated JSON objects
    const jsonObjects = cleaned.match(/\{[^{}]*\}/g);
    if (jsonObjects && jsonObjects.length > 1) {
        // Keep only the first one that looks like AI response
        for (const obj of jsonObjects) {
            if (obj.includes('raw_response') || obj.includes('"response"')) {
                try {
                    const parsed = JSON.parse(obj);
                    if (parsed.raw_response || parsed.response) {
                        cleaned = parsed.raw_response || parsed.response;
                        break;
                    }
                } catch (e) {
                    // Continue
                }
            }
        }
    }
    
    return cleaned;
}

function cleanAIResponse(response) {
    if (!response) return '';
    
    let cleaned = response;
    
    // Remove any remaining JSON artifacts
    cleaned = cleaned.replace(/^\{[^}]*"raw_response"\s*:\s*"/, '');
    cleaned = cleaned.replace(/"\s*\}[^}]*$/, '');
    
    // Unescape common sequences
    cleaned = cleaned.replace(/\\"/g, '"')
                    .replace(/\\n/g, '\n')
                    .replace(/\\t/g, '\t')
                    .replace(/\\r/g, '\r')
                    .replace(/\\\\/g, '\\');
    
    // Remove any trailing second JSON object
    const secondJsonIndex = cleaned.indexOf('}{');
    if (secondJsonIndex !== -1) {
        cleaned = cleaned.substring(0, secondJsonIndex + 1);
    }
    
    // Trim whitespace
    cleaned = cleaned.trim();
    
    return cleaned;
}

function createFallbackFix(vulnerability) {
    return `# AI Fix Assistant - Fallback Response

## Vulnerability: ${vulnerability.type || 'Unknown'}
**Severity:** ${vulnerability.severity || 'Unknown'}
**Description:** ${vulnerability.description || 'No description available'}

## Step-by-Step Fix:

### 1. Immediate Action Required
1. Review the vulnerability details in the scan report
2. Prioritize based on severity: ${vulnerability.severity || 'HIGH'}

### 2. Technical Implementation
${vulnerability.remediation || 'Implement the recommended security controls'}

### 3. Testing & Verification
1. Apply the fix in a staging/development environment first
2. Test thoroughly before deploying to production
3. Re-run the security scan to verify the fix

### 4. Best Practices
- Implement security headers
- Regular security scanning
- Keep software updated
- Follow secure coding practices

**Note:** The AI assistant experienced a technical issue. Please refer to the detailed remediation steps above and consult security documentation for this specific vulnerability type.`;
}

function createVulnerabilityPrompt(vulnerability) {
    return `You are a cybersecurity expert. Provide a detailed, step-by-step fix for the following vulnerability:

VULNERABILITY DETAILS:
- Type: ${vulnerability.type}
- Severity: ${vulnerability.severity}
- Description: ${vulnerability.description}
- Impact: ${vulnerability.impact}
- Current Remediation: ${vulnerability.remediation}
- Location: ${vulnerability.location}
- Evidence: ${vulnerability.evidence || 'Not provided'}

Please provide:
1. A comprehensive step-by-step fix guide
2. Code examples where applicable
3. Best practices to prevent recurrence
4. Testing steps to verify the fix
5. Any additional security considerations

Format the response in clear, actionable steps with code snippets where helpful.`;
}

async function callOllamaAPI(prompt) {
    try {
        console.log('Calling Ollama API with prompt...');
        
        const formData = new FormData();
        formData.append('tool', 'ollama');
        formData.append('prompt', prompt);
        formData.append('model', 'gemma3:4b');
        
        const response = await fetch('api.php', {
            method: 'POST',
            body: formData,
            signal: AbortSignal.timeout(300000) // 300 seconds for larger responses
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const responseText = await response.text();
        console.log('Raw response received, length:', responseText.length);
        
        // DEBUG: Show what we received
        console.log('=== DEBUG: Full Response Start ===');
        console.log(responseText);
        console.log('=== DEBUG: Full Response End ===');
        
        // The issue: response contains TWO JSON objects concatenated
        // We need to extract the FIRST one which has the actual response
        
        let aiResponse = '';
        
        // Method 1: Try to find the first complete JSON object
        const jsonStart = responseText.indexOf('{');
        let jsonEnd = -1;
        let braceCount = 0;
        
        // Find matching closing brace for the first JSON object
        for (let i = jsonStart; i < responseText.length; i++) {
            if (responseText[i] === '{') {
                braceCount++;
            } else if (responseText[i] === '}') {
                braceCount--;
                if (braceCount === 0) {
                    jsonEnd = i;
                    break;
                }
            }
        }
        
        if (jsonStart !== -1 && jsonEnd !== -1) {
            const firstJson = responseText.substring(jsonStart, jsonEnd + 1);
            console.log('Extracted first JSON, length:', firstJson.length);
            
            try {
                const parsed = JSON.parse(firstJson);
                console.log('Successfully parsed first JSON');
                
                // Extract the AI response from various possible locations
                if (parsed.response && parsed.response.raw_response) {
                    aiResponse = parsed.response.raw_response;
                    console.log('Found response in parsed.response.raw_response');
                } else if (parsed.raw_response) {
                    aiResponse = parsed.raw_response;
                    console.log('Found response in parsed.raw_response');
                } else if (parsed.response) {
                    aiResponse = typeof parsed.response === 'string' ? parsed.response : JSON.stringify(parsed.response, null, 2);
                    console.log('Found response in parsed.response');
                } else if (parsed.analysis) {
                    aiResponse = parsed.analysis;
                    console.log('Found response in parsed.analysis');
                } else {
                    // If we can't find the response, show the parsed data
                    aiResponse = JSON.stringify(parsed, null, 2);
                    console.log('No specific response field found, using full parsed data');
                }
            } catch (parseError) {
                console.error('Failed to parse first JSON:', parseError);
                // Fallback to text extraction
                aiResponse = extractResponseFromText(responseText);
            }
        } else {
            // If we can't find complete JSON, try extraction
            console.log('Could not find complete JSON, trying text extraction');
            aiResponse = extractResponseFromText(responseText);
        }
        
        // Clean up the response
        if (aiResponse) {
            aiResponse = cleanAIResponse(aiResponse);
            console.log('Final AI response length:', aiResponse.length);
            console.log('Response preview:', aiResponse.substring(0, 300) + '...');
        } else {
            aiResponse = 'No AI response generated.';
        }
        
        return aiResponse;
        
    } catch (error) {
        console.error('Ollama API call failed:', error);
        throw error;
    }
}

function extractResponseFromText(text) {
    console.log('Attempting to extract response from text...');
    
    // Try multiple extraction patterns
    const patterns = [
        // Pattern 1: Look for raw_response with full content (including newlines)
        /"raw_response"\s*:\s*"([\s\S]*?)"(?=\s*[,}])/,
        
        // Pattern 2: Look for analysis field
        /"analysis"\s*:\s*"([\s\S]*?)"(?=\s*[,}])/,
        
        // Pattern 3: Look for response field
        /"response"\s*:\s*"([\s\S]*?)"(?=\s*[,}])/,
        
        // Pattern 4: Look for any text content between quotes after known fields
        /"(?:raw_response|analysis|response)"\s*:\s*"([^"]*)"/,
    ];
    
    for (const pattern of patterns) {
        const match = text.match(pattern);
        if (match && match[1]) {
            console.log(`Found match with pattern: ${pattern}`);
            let extracted = match[1];
            
            // Unescape JSON string
            extracted = extracted.replace(/\\"/g, '"')
                                .replace(/\\n/g, '\n')
                                .replace(/\\t/g, '\t')
                                .replace(/\\r/g, '\r')
                                .replace(/\\\\/g, '\\')
                                .replace(/\\u([\dA-Fa-f]{4})/g, (match, hex) => 
                                    String.fromCharCode(parseInt(hex, 16)));
            
            return extracted;
        }
    }
    
    // If no pattern matches, try to get any meaningful text
    console.log('No patterns matched, looking for meaningful text...');
    
    // Remove the second JSON object (the empty one)
    const secondJsonStart = text.lastIndexOf('{');
    if (secondJsonStart > text.indexOf('}')) {
        const firstPart = text.substring(0, secondJsonStart).trim();
        // Try to parse what's left
        try {
            const parsed = JSON.parse(firstPart);
            if (parsed.response && parsed.response.raw_response) {
                return parsed.response.raw_response;
            }
        } catch (e) {
            // If parsing fails, return the text as-is
            return firstPart;
        }
    }
    
    // Last resort: return the text as-is
    return text;
}

// async function callOllamaAPI(prompt) {
//     try {
//         const response = await fetch('api.php', {
//             method: 'POST',
//             headers: {
//                 'Content-Type': 'application/x-www-form-urlencoded',
//             },
//             body: new URLSearchParams({
//                 'tool': 'ollama',
//                 'prompt': prompt,
//                 'model': 'gemma3:4b'
//             })
//         });

//         if (!response.ok) {
//             throw new Error(`HTTP error! status: ${response.status}`);
//         }

//         const responseText = await response.text();
//         console.log('Raw API response:', responseText);

//         // Handle the case where we might have concatenated JSON objects
//         let data;
        
//         // First, try to parse the whole response as JSON
//         try {
//             data = JSON.parse(responseText);
//         } catch (firstError) {
//             console.log('First parse failed, trying to extract valid JSON...');
            
//             // Try to find valid JSON objects in the response
//             // Look for JSON-like patterns
//             const jsonMatches = responseText.match(/\{[^{}]*\}/g);
            
//             if (jsonMatches && jsonMatches.length > 0) {
//                 // Try each potential JSON object
//                 for (let i = 0; i < jsonMatches.length; i++) {
//                     try {
//                         data = JSON.parse(jsonMatches[i]);
//                         if (data.success || data.response || data.raw_response) {
//                             console.log('Found valid JSON at match', i);
//                             break;
//                         }
//                     } catch (e) {
//                         // Continue trying other matches
//                         continue;
//                     }
//                 }
//             }
            
//             // If still no valid data, try manual extraction
//             if (!data) {
//                 console.log('Attempting manual JSON extraction...');
                
//                 // The response shows two JSON objects concatenated
//                 // Let's try to find the boundary
//                 const firstJsonEnd = responseText.indexOf('}') + 1;
//                 if (firstJsonEnd > 0) {
//                     const firstPart = responseText.substring(0, firstJsonEnd);
//                     const secondPart = responseText.substring(firstJsonEnd);
                    
//                     console.log('First part:', firstPart);
//                     console.log('Second part:', secondPart);
                    
//                     try {
//                         data = JSON.parse(firstPart);
//                     } catch (e) {
//                         try {
//                             data = JSON.parse(secondPart);
//                         } catch (e2) {
//                             // If both fail, try to clean the response
//                             const cleanedResponse = responseText
//                                 .replace(/\n/g, ' ')
//                                 .replace(/\r/g, ' ')
//                                 .replace(/\t/g, ' ')
//                                 .replace(/  +/g, ' ')
//                                 .trim();
                            
//                             // Look for the main response pattern
//                             if (cleanedResponse.includes('"raw_response"')) {
//                                 const start = cleanedResponse.indexOf('"raw_response":');
//                                 const end = cleanedResponse.lastIndexOf('}');
//                                 const jsonStr = cleanedResponse.substring(start - 1, end + 1);
//                                 const fullJson = '{' + jsonStr;
                                
//                                 try {
//                                     data = JSON.parse(fullJson);
//                                 } catch (e3) {
//                                     // Last resort: create a simple response object
//                                     data = {
//                                         success: true,
//                                         response: {
//                                             raw_response: cleanedResponse
//                                         }
//                                     };
//                                 }
//                             } else {
//                                 // Create response from the cleaned text
//                                 data = {
//                                     success: true,
//                                     response: {
//                                         raw_response: cleanedResponse
//                                     }
//                                 };
//                             }
//                         }
//                     }
//                 }
//             }
//         }

//         // If we still don't have data, throw an error
//         if (!data) {
//             throw new Error('Could not parse response from server');
//         }

//         console.log('Processed response data:', data);

//         // Extract the AI response from various possible structures
//         let aiResponse = '';
        
//         // Check multiple possible response structures
//         if (data.response && data.response.raw_response) {
//             aiResponse = data.response.raw_response;
//         } else if (data.response && typeof data.response === 'string') {
//             aiResponse = data.response;
//         } else if (data.raw_response) {
//             aiResponse = data.raw_response;
//         } else if (data.data && data.data.response) {
//             aiResponse = data.data.response;
//         } else if (data.analysis) {
//             aiResponse = data.analysis;
//         } else if (data.data && data.data.analysis) {
//             aiResponse = data.data.analysis;
//         } else if (typeof data === 'string') {
//             aiResponse = data;
//         } else if (data.success && data.response) {
//             // Try to stringify the response object
//             aiResponse = JSON.stringify(data.response, null, 2);
//         } else {
//             // Fallback: return the whole data as string
//             aiResponse = JSON.stringify(data, null, 2);
//         }

//         // Clean up the response (remove any trailing JSON objects)
//         if (typeof aiResponse === 'string') {
//             // If there's a second JSON object at the end, remove it
//             const jsonObjectEnd = aiResponse.indexOf('}');
//             if (jsonObjectEnd !== -1 && jsonObjectEnd < aiResponse.length - 1) {
//                 // Check if what comes after looks like another JSON object
//                 const afterFirstJson = aiResponse.substring(jsonObjectEnd + 1).trim();
//                 if (afterFirstJson.startsWith('{')) {
//                     // Take only the first JSON object
//                     aiResponse = aiResponse.substring(0, jsonObjectEnd + 1);
//                 }
//             }
            
//             // Also clean any concatenated JSON at the beginning
//             aiResponse = aiResponse.replace(/^\s*\{.*?\}\s*\{/, '{');
//         }

//         return aiResponse;
        
//     } catch (error) {
//         console.error('Ollama API call failed:', error);
//         throw error;
//     }
// }

function sendUserMessage() {
    if (!aiFixModal || !currentVulnerability) return;

    const userInput = aiFixModal.querySelector('#userQuestion');
    const message = userInput.value.trim();
    
    if (!message) return;

    // Display user message
    displayUserMessage(message);
    
    // Clear input
    userInput.value = '';
    
    // Generate AI response
    showTypingIndicator();
    
    const followUpPrompt = `Previous context: ${chatHistory.map(msg => msg.content).join('\n')}
    
User follow-up question: ${message}

Please provide a helpful response focusing on the vulnerability fix: ${currentVulnerability.type}`;

    callOllamaAPI(followUpPrompt)
        .then(aiResponse => {
            hideTypingIndicator();
            displayAIResponse(aiResponse, false);
        })
        .catch(error => {
            hideTypingIndicator();
            displayErrorMessage('Failed to get AI response. Please try again.');
            console.error('Ollama API error:', error);
        });
}

function displayUserMessage(message) {
    if (!aiFixModal) return;

    const chatMessages = aiFixModal.querySelector('#chatMessages');
    
    const messageElement = document.createElement('div');
    messageElement.className = 'chat-message message-user';
    messageElement.innerHTML = `
        <div class="message-header">
            <i class="fas fa-user"></i>
            <span>You</span>
        </div>
        <div class="message-content">${escapeHtml(message)}</div>
    `;
    
    chatMessages.appendChild(messageElement);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // Add to chat history
    chatHistory.push({ role: 'user', content: message });
}

function displayAIResponse(response, isInitial = false) {
    if (!aiFixModal) return;

    const chatMessages = aiFixModal.querySelector('#chatMessages');
    
    console.log('Displaying AI response:', {
        isInitial,
        responseType: typeof response,
        responseLength: response ? response.length : 0
    });
    
    let responseText = response;
    
    // If response is an object, stringify it
    if (typeof response === 'object') {
        try {
            responseText = JSON.stringify(response, null, 2);
        } catch (e) {
            responseText = String(response);
        }
    } else if (typeof response !== 'string') {
        responseText = String(response);
    }
    
    // Clean the response text
    responseText = cleanDisplayResponse(responseText);
    
    // Format for display
    let formattedResponse = formatAIResponse(responseText);
    
    const messageElement = document.createElement('div');
    messageElement.className = 'chat-message message-ai';
    
    messageElement.innerHTML = `
        <div class="message-header">
            <i class="fas fa-robot"></i>
            <span>AI Security Assistant</span>
        </div>
        <div class="message-content">${formattedResponse}</div>
    `;
    
    chatMessages.appendChild(messageElement);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // Add to chat history
    chatHistory.push({ role: 'assistant', content: responseText });
}

function cleanDisplayResponse(response) {
    if (!response) return 'No response received from AI assistant.';
    
    let cleaned = response;
    
    // Remove any JSON wrapper artifacts
    if (cleaned.startsWith('{') && cleaned.includes('"raw_response"')) {
        try {
            // Try to parse as JSON and extract raw_response
            const parsed = JSON.parse(cleaned);
            if (parsed.response && parsed.response.raw_response) {
                cleaned = parsed.response.raw_response;
            } else if (parsed.raw_response) {
                cleaned = parsed.raw_response;
            } else if (parsed.response) {
                cleaned = parsed.response;
            }
        } catch (e) {
            // If parsing fails, try to extract manually
            const match = cleaned.match(/"raw_response"\s*:\s*"([\s\S]*?)"(?=\s*[,}])/);
            if (match && match[1]) {
                cleaned = match[1];
            }
        }
    }
    
    // Unescape JSON string characters
    cleaned = cleaned.replace(/\\"/g, '"')
                    .replace(/\\n/g, '\n')
                    .replace(/\\t/g, '\t')
                    .replace(/\\r/g, '\r')
                    .replace(/\\\\/g, '\\');
    
    return cleaned;
}

function formatAIResponse(response) {
    if (!response) return 'No response available.';
    
    // Convert markdown-like formatting to HTML
    let formatted = escapeHtml(response);
    
    // Convert headers (lines starting with #)
    formatted = formatted.replace(/^# (.*$)/gm, '<h4 style="color: #3b82f6; margin: 1rem 0 0.5rem 0;">$1</h4>');
    formatted = formatted.replace(/^## (.*$)/gm, '<h5 style="color: #4b5563; margin: 0.75rem 0 0.5rem 0;">$1</h5>');
    formatted = formatted.replace(/^### (.*$)/gm, '<h6 style="color: #6b7280; margin: 0.5rem 0 0.25rem 0;">$1</h6>');
    
    // Convert bold text (**text**)
    formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    
    // Convert code blocks
    formatted = formatted.replace(/```([\s\S]*?)```/g, '<pre class="code-block"><code>$1</code></pre>');
    
    // Convert inline code (`code`)
    formatted = formatted.replace(/`([^`]+)`/g, '<code class="inline-code">$1</code>');
    
    // Convert numbered lists
    formatted = formatted.replace(/^(\d+)\.\s+(.*)$/gm, '<div class="step-item"><span class="step-number">$1</span><span class="step-text">$2</span></div>');
    
    // Convert bullet points
    formatted = formatted.replace(/^[-*]\s+(.*)$/gm, '<div class="bullet-item"><i class="fas fa-circle" style="font-size: 0.5rem; margin-right: 0.5rem;"></i><span>$1</span></div>');
    
    // Convert line breaks
    formatted = formatted.replace(/\n/g, '<br>');
    
    return formatted;
}

function showTypingIndicator() {
    if (!aiFixModal) return;

    const typingIndicator = aiFixModal.querySelector('#typingIndicator');
    const userInput = aiFixModal.querySelector('#userQuestion');
    const sendBtn = aiFixModal.querySelector('#sendQuestion');
    
    if (typingIndicator) typingIndicator.style.display = 'flex';
    if (userInput) userInput.disabled = true;
    if (sendBtn) sendBtn.disabled = true;
}

function hideTypingIndicator() {
    if (!aiFixModal) return;

    const typingIndicator = aiFixModal.querySelector('#typingIndicator');
    const userInput = aiFixModal.querySelector('#userQuestion');
    const sendBtn = aiFixModal.querySelector('#sendQuestion');
    
    if (typingIndicator) typingIndicator.style.display = 'none';
    if (userInput) userInput.disabled = false;
    if (sendBtn) sendBtn.disabled = false;
}

function displayErrorMessage(message) {
    if (!aiFixModal) return;

    const chatMessages = aiFixModal.querySelector('#chatMessages');
    
    const errorElement = document.createElement('div');
    errorElement.className = 'chat-message message-ai';
    errorElement.innerHTML = `
        <div class="message-header">
            <i class="fas fa-exclamation-triangle"></i>
            <span>System</span>
        </div>
        <div class="message-content" style="color: #dc2626;">
            ${escapeHtml(message)}
        </div>
    `;
    
    chatMessages.appendChild(errorElement);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function enableActionButtons() {
    if (!aiFixModal) return;

    const copyBtn = aiFixModal.querySelector('#copyFix');
    const exportBtn = aiFixModal.querySelector('#exportFix');
    
    if (copyBtn) copyBtn.disabled = false;
    if (exportBtn) exportBtn.disabled = false;
}

function copyFixToClipboard() {
    if (!aiFixModal) return;

    const aiMessages = aiFixModal.querySelectorAll('.message-ai .message-content');
    let fullText = '';
    
    aiMessages.forEach(message => {
        fullText += message.textContent + '\n\n';
    });
    
    navigator.clipboard.writeText(fullText.trim())
        .then(() => {
            showNotification('Fix copied to clipboard!', 'success');
        })
        .catch(err => {
            console.error('Failed to copy text: ', err);
            showNotification('Failed to copy to clipboard', 'error');
        });
}

function exportFixAsText() {
    if (!aiFixModal || !currentVulnerability) return;

    const aiMessages = aiFixModal.querySelectorAll('.message-ai .message-content');
    let fullText = `AI Security Fix for: ${currentVulnerability.type}\n`;
    fullText += `Severity: ${currentVulnerability.severity}\n`;
    fullText += `Generated: ${new Date().toLocaleString()}\n\n`;
    
    aiMessages.forEach(message => {
        fullText += message.textContent + '\n\n';
    });
    
    const blob = new Blob([fullText], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `security-fix-${currentVulnerability.type.toLowerCase().replace(/\s+/g, '-')}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function escapeHtml(unsafe) {
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

function initializeVulnerabilityScanner() {
    // Your existing scanner initialization code...
    
    // Create AI Fix Modal when scanner is initialized
    createAIFixModal();
}

// Call initialization when the page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeVulnerabilityScanner();
});

