<?php 
require_once __DIR__ . '/classes/AccessControl.php';
require_once __DIR__ . '/classes/Auth.php';

$auth = new Auth();
$accessControl = new AccessControl();
$toolName = 'vulnerability-scanner';

// If user is not logged In, do this....
// Check if user is logged in
if (!$auth->isLoggedIn()) {
    header('Location: plan.php');
    exit;
}

// Check if user has permission to access this tool
$accessControl->requireToolAccess($toolName, 'plan.php');

require_once __DIR__ . '/includes/header-new.php';
?>
<body>
    <!-- Header -->
    <?php require_once __DIR__ . '/includes/nav-new.php'; ?>
    <!-- Vulnerability Scanner Tool -->
     <div class="gap"></div>
    <div class="container">
        <div class="tool-page">
            <a href="index.php" class="back-btn">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
            
            <div class="tool-header">
                <i class="fas fa-bug"></i>
                <h2>Vulnerability Scanner</h2> 
            </div>
            
            <div class="input-group">
                <label for="target-url">Target URL</label>
                <input type="url" id="target-url" placeholder="https://example.com" required>
            </div>
            
            <div class="input-group">
                <label for="scan-type">Scan Type</label>
                <select id="scan-type">
                    <option value="quick">Quick Scan</option>
                    <option value="full">Full Scan</option>
                    <option value="cms">CMS Specific</option>
                    <option value="api">API Endpoints</option>
                </select>
            </div>
            
            <button id="vuln-btn" class="btn btn-primary" onclick="runVulnerabilityScan()">
                <i class="fas fa-search"></i> Start Scan
            </button>

           <?php if ($auth->hasAnyRole(['admin', 'moderator', 'premium'])): ?>
            <button class="btn btn-primary">
                <a href="schedule-vuln-scan.php" style="color: white; text-decoration: none;">
                    <i class="fas fa-calendar-alt"></i> Manage Scheduled Scans
                </a>
           </button>
            <?php endif; ?>

            <div class="loading" id="vuln-loading">
                <div class="spinner-container">
                    <div class="spinner"></div>
                    <h4>Scanning in Progress</h4>
                    <div id="current-task" class="current-task"></div>
                    <div class="scan-tips">
                        <small class="text-muted">
                            <i class="fas fa-lightbulb"></i> 
                            Tip: Scanning may take more than 20 minutes depending on the target complexity.
                        </small>
                    </div>
                </div>
            </div>
            <div class="results-container" id="vuln-results">
                <div class="results-header">
                    <h3>Scan Results</h3>
                    <span id="scan-summary">0 vulnerabilities found</span>
                </div>
                
                <div class="result-card">
                    <h3>Vulnerabilities</h3>
                    <div id="vulnerabilities-list"></div>
                </div>
                
                <div class="chart-container">
                    <canvas id="vuln-chart"></canvas>
                </div>
                
                <div class="result-card">
                    <h3>Recommendations</h3>
                    <div id="recommendations"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <?php require_once __DIR__ . '/includes/login-modal.php'; ?>

    <?php require_once __DIR__ . '/includes/footer.php'; ?>

    <script src="assets/js/vulnerability-scanner.js"></script>
    <script src="assets/js/auth.js"></script>
    <link rel="stylesheet" href="assets/styles/vulnerability.css">
    <link rel="stylesheet" href="assets/styles/modal.css">
</body>
</html>